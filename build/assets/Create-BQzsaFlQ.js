import{s as pt,r as b,T as bt,x as yt,k as z,B as J,E as F,J as G,o as vt,R as ft,a,c as ht,w as _t,b as s,d as y,t as i,l as V,y as $,u,I as U,S as H,e as l,F as B,g as L,n as M,f as m,i as S}from"./app-rrtI315f.js";import{_ as gt}from"./AuthenticatedLayout-CiFcEoWJ.js";import{_ as kt}from"./InputError-BdcX_tC4.js";import{C as Ct}from"./vue-select-Fp3dJLbh.js";import{d as W,M as wt}from"./debounce-3VSykR-V.js";import{_ as qt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const xt={class:"pos-header"},It={class:"d-flex justify-content-between align-items-center"},Ft={class:"pos-title"},Vt={class:"pos-container"},$t={class:"pos-products-panel"},Et={class:"pos-search-section"},Dt={class:"search-input-group"},At=["placeholder"],Pt={class:"barcode-section"},Ut=["placeholder"],Bt={key:0,class:"pos-categories"},Lt=["onClick"],Mt={class:"pos-products-grid"},St=["onClick"],Ot={class:"product-image"},Tt=["src","alt"],Nt={key:0,class:"product-stock-badge"},Kt={class:"product-info"},Qt={class:"product-name"},Rt={class:"product-model"},jt={class:"product-price"},zt={class:"product-stock"},Jt={key:1,class:"text-center p-4"},Gt={key:2,class:"no-products"},Ht={class:"pos-cart-panel"},Wt={class:"pos-customer-section"},Xt={class:"form-label text-center w-100"},Yt={class:"pos-cart-section"},Zt={class:"cart-header"},ts={class:"text-center w-100"},ss={key:0,class:"cart-count"},es={class:"cart-items"},os={class:"cart-item-info"},ns={class:"item-name"},as={class:"item-model"},is={class:"cart-item-controls"},ls={class:"quantity-controls"},rs=["onClick","disabled"],us=["onUpdate:modelValue","onInput"],cs=["onClick"],ds={class:"price-controls"},ms=["onUpdate:modelValue"],ps={class:"item-total"},bs=["onClick"],ys={key:0,class:"empty-cart"},vs={key:0,class:"pos-summary-section"},fs={class:"summary-row"},hs={class:"summary-row"},_s={class:"summary-row total-row"},gs={class:"total-amount"},ks={key:1,class:"pos-actions-section"},Cs=["disabled"],ws={key:0,class:"bi bi-credit-card"},qs={key:1,class:"spinner-border spinner-border-sm"},xs={key:0,class:"keyboard-shortcuts"},Is={__name:"Create",props:{products:Array,customers:Array,defaultCustomer:Object,translations:Object,defaultCurrency:String,categories:Array},setup(r){var j;let p=pt(),w=b(!1),h=b(""),v=b(""),g=b(!1),O=b(!1),q=b(null),E=b(!1);const T=b(null),x=b(null),d=r,k=b(d.defaultCustomer),C=bt({customer_id:((j=d.defaultCustomer)==null?void 0:j.id)||null,total_amount:0}),n=yt([]),f=b([...d.products]),D=z(()=>n.reduce((e,t)=>e+t.quantity*t.price,0)),X=z(()=>n.reduce((e,t)=>e+t.quantity,0));J(D,e=>{C.total_amount=e}),J(v,W(()=>{P()},300));const Y=e=>{k.value=e,C.customer_id=e?e.id:null},N=e=>{if(e.quantity<=0){p.warning("المنتج غير متوفر في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0});return}const t=n.find(o=>o.product_id===e.id);t?t.quantity<e.quantity?t.quantity+=1:p.warning("لا توجد كمية كافية في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0}):n.push({product_id:e.id,quantity:1,price:e.price})},Z=e=>{n.splice(e,1)},tt=e=>{const t=n[e],o=d.products.find(c=>c.id===t.product_id);t.quantity<o.quantity?t.quantity+=1:p.warning("لا توجد كمية كافية في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0})},st=e=>{const t=n[e];t.quantity>1&&(t.quantity-=1)},A=()=>{n.splice(0)},K=()=>{A(),k.value=null,C.customer_id=null,v.value="",h.value="",f.value=[...d.products]},P=()=>{if(!v.value.trim()){f.value=[...d.products];return}const e=v.value.toLowerCase();f.value=d.products.filter(t=>t.name.toLowerCase().includes(e)||t.model.toLowerCase().includes(e)||t.barcode&&t.barcode.toLowerCase().includes(e))},et=()=>{f.value.length===1&&(N(f.value[0]),v.value="",f.value=[...d.products])},ot=e=>{q.value=e},nt=()=>{q.value=null,f.value=[...d.products]},at=e=>{const t=d.products.find(o=>o.id===e);return t?t.name:""},it=e=>{const t=d.products.find(o=>o.id===e);return t?t.model:""},lt=e=>{e.target.src="/dashboard-assets/img/product-placeholder.svg"},rt=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()},ut=()=>{p.info("تم تعليق الطلب",{timeout:3e3,position:"bottom-right",rtl:!0})},ct=()=>{window.print()},Q=()=>{g.value=!0},dt=async e=>{w.value=!0;const t={total_amount:C.total_amount,total_paid:e.amountDollar??0,customer_id:C.customer_id,date:e.date,notes:e.notes,discount_amount:e.discount_amount??0,discount_rate:e.discount_rate??0,items:n.map(o=>({product_id:o.product_id,quantity:o.quantity,price:o.price}))};try{const o=await F.post("/api/createOrder",t);if(o.status===200||o.status===201){let{id:c,order_id:_}=o.data;p.success("تم حفظ الفاتورة بنجاح",{timeout:3e3,position:"bottom-right",rtl:!0}),e.printInvoice&&window.open(`/api/getIndexAccountsSelas?print=2&transactions_id=${c}&order_id=${_}`,"_blank"),A(),v.value="",h.value="",f.value=[...d.products]}}catch{p.error("خطأ أثناء حفظ الفاتورة",{timeout:5e3,position:"bottom-right",rtl:!0})}finally{w.value=!1,g.value=!1}},I=W(async()=>{if(h.value)try{const e=await F.get(`/api/products/${h.value}`);if(e.data.id){const t=await F.get(`/api/check-stock/${e.data.id}`);if(t.data.available_quantity>0){const o=n.find(c=>c.product_id===e.data.id);o?o.quantity+1<=t.data.available_quantity?o.quantity+=1:p.warning("لا توجد كمية كافية في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0}):n.push({product_id:e.data.id,quantity:1,price:e.data.price}),h.value="",G(()=>{var c;(c=x.value)==null||c.focus()})}else p.warning("المادة غير متوفرة في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0})}else p.error("تعذر العثور على المنتج",{timeout:3e3,position:"bottom-right",rtl:!0})}catch{p.warning("المادة غير متوفرة في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0})}},500),mt=async e=>{try{const t=await F.get(`/api/check-stock/${e.product_id}`);e.quantity>t.data.available_quantity&&(p.warning(`الكمية المتوفرة فقط: ${t.data.available_quantity}`,{timeout:3e3,position:"bottom-right",rtl:!0}),e.quantity=t.data.available_quantity)}catch(t){console.error("خطأ عند التحقق من المخزون:",t)}},R=e=>{var t,o;e.key==="F1"&&(e.preventDefault(),(t=T.value)==null||t.focus()),e.key==="F2"&&(e.preventDefault(),(o=x.value)==null||o.focus()),e.key==="F9"&&n.length>0&&k.value&&(e.preventDefault(),Q()),e.key==="Escape"&&(e.preventDefault(),K()),e.key==="F12"&&(e.preventDefault(),E.value=!E.value)};return vt(()=>{document.addEventListener("keydown",R),G(()=>{var e;(e=x.value)==null||e.focus()})}),ft(()=>{document.removeEventListener("keydown",R)}),(e,t)=>(a(),ht(gt,{translations:r.translations},{default:_t(()=>[s("div",xt,[s("div",It,[s("h2",Ft,[t[6]||(t[6]=s("i",{class:"bi bi-shop"},null,-1)),y(" "+i(r.translations.invoice),1)]),s("div",{class:"pos-actions"},[s("button",{onClick:K,class:"btn btn-outline-danger"},t[7]||(t[7]=[s("i",{class:"bi bi-trash"},null,-1),y(" مسح الكل ")])),s("button",{onClick:rt,class:"btn btn-outline-primary"},t[8]||(t[8]=[s("i",{class:"bi bi-fullscreen"},null,-1),y(" ملء الشاشة ")]))])])]),s("div",Vt,[s("div",$t,[s("div",Et,[s("div",Dt,[V(s("input",{ref_key:"searchInput",ref:T,"onUpdate:modelValue":t[0]||(t[0]=o=>U(v)?v.value=o:v=o),type:"text",class:"form-control pos-search-input",placeholder:r.translations.search_by_name_or_barcode,onInput:P,onKeyup:H(et,["enter"])},null,40,At),[[$,u(v)]]),s("button",{class:"btn btn-primary search-btn",onClick:P},t[9]||(t[9]=[s("i",{class:"bi bi-search"},null,-1)]))]),s("div",Pt,[V(s("input",{ref_key:"barcodeInput",ref:x,"onUpdate:modelValue":t[1]||(t[1]=o=>U(h)?h.value=o:h=o),type:"text",class:"form-control barcode-input",placeholder:r.translations.barcode,onKeyup:[t[2]||(t[2]=(...o)=>u(I)&&u(I)(...o)),t[3]||(t[3]=H((...o)=>u(I)&&u(I)(...o),["enter"]))]},null,40,Ut),[[$,u(h)]]),t[10]||(t[10]=s("i",{class:"bi bi-upc-scan barcode-icon"},null,-1))])]),r.categories&&r.categories.length?(a(),l("div",Bt,[(a(!0),l(B,null,L(r.categories,o=>(a(),l("button",{key:o.id,onClick:c=>ot(o.id),class:M(["btn","category-btn",{active:u(q)===o.id}])},i(o.name),11,Lt))),128)),s("button",{onClick:nt,class:M(["btn","category-btn",{active:u(q)===null}])}," الكل ",2)])):m("",!0),s("div",Mt,[(a(!0),l(B,null,L(f.value,o=>(a(),l("div",{key:o.id,onClick:c=>N(o),class:M(["product-card",{"out-of-stock":o.quantity<=0}])},[s("div",Ot,[s("img",{src:o.image_url||"/dashboard-assets/img/product-placeholder.svg",alt:o.name,onError:lt},null,40,Tt),o.quantity<=5?(a(),l("div",Nt,i(o.quantity),1)):m("",!0)]),s("div",Kt,[s("h6",Qt,i(o.name),1),s("p",Rt,i(o.model),1),s("div",jt,i(r.defaultCurrency)+" "+i(o.price),1),s("div",zt," المخزون: "+i(o.quantity),1)])],10,St))),128))]),u(O)?(a(),l("div",Jt,t[11]||(t[11]=[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"جاري التحميل...")],-1)]))):m("",!0),!u(O)&&f.value.length===0?(a(),l("div",Gt,t[12]||(t[12]=[s("i",{class:"bi bi-box-seam"},null,-1),s("p",null,"لا توجد منتجات",-1)]))):m("",!0)]),s("div",Ht,[s("div",Wt,[s("label",Xt,i(r.translations.client),1),S(u(Ct),{modelValue:k.value,"onUpdate:modelValue":t[4]||(t[4]=o=>k.value=o),options:r.customers,label:"name","track-by":"id",reduce:o=>o,onInput:Y,placeholder:r.translations.select_customer,class:"customer-select"},null,8,["modelValue","options","reduce","placeholder"]),S(kt,{message:u(C).errors.customer_id},null,8,["message"])]),s("div",Yt,[s("div",Zt,[s("h5",ts,[t[13]||(t[13]=s("i",{class:"bi bi-cart3"},null,-1)),t[14]||(t[14]=y(" عربة التسوق ")),n.length?(a(),l("span",ss,i(n.length),1)):m("",!0)]),n.length?(a(),l("button",{key:0,onClick:A,class:"btn btn-sm btn-outline-danger"},t[15]||(t[15]=[s("i",{class:"bi bi-trash"},null,-1)]))):m("",!0)]),s("div",es,[(a(!0),l(B,null,L(n,(o,c)=>(a(),l("div",{key:c,class:"cart-item"},[s("div",os,[s("h6",ns,i(at(o.product_id)),1),s("p",as,i(it(o.product_id)),1)]),s("div",is,[s("div",ls,[s("button",{onClick:_=>st(c),class:"btn btn-sm btn-outline-secondary",disabled:o.quantity<=1},t[16]||(t[16]=[s("i",{class:"bi bi-dash"},null,-1)]),8,rs),V(s("input",{"onUpdate:modelValue":_=>o.quantity=_,type:"number",min:"1",class:"form-control quantity-input",onInput:_=>mt(o)},null,40,us),[[$,o.quantity,void 0,{number:!0}]]),s("button",{onClick:_=>tt(c),class:"btn btn-sm btn-outline-secondary"},t[17]||(t[17]=[s("i",{class:"bi bi-plus"},null,-1)]),8,cs)]),s("div",ds,[V(s("input",{"onUpdate:modelValue":_=>o.price=_,type:"number",min:"0",step:"0.01",class:"form-control price-input"},null,8,ms),[[$,o.price,void 0,{number:!0}]])]),s("div",ps,i(r.defaultCurrency)+" "+i((o.quantity*o.price).toFixed(2)),1),s("button",{onClick:_=>Z(c),class:"btn btn-sm btn-danger remove-btn"},t[18]||(t[18]=[s("i",{class:"bi bi-x"},null,-1)]),8,bs)])]))),128))]),n.length===0?(a(),l("div",ys,t[19]||(t[19]=[s("i",{class:"bi bi-cart-x"},null,-1),s("p",{class:"text-center"},"عربة التسوق فارغة",-1),s("small",{class:"text-center"},"اضغط على المنتجات لإضافتها",-1)]))):m("",!0)]),n.length>0?(a(),l("div",vs,[s("div",fs,[t[20]||(t[20]=s("span",null,"عدد الأصناف:",-1)),s("span",null,i(n.length),1)]),s("div",hs,[t[21]||(t[21]=s("span",null,"إجمالي الكمية:",-1)),s("span",null,i(X.value),1)]),s("div",_s,[t[22]||(t[22]=s("span",null,"الإجمالي:",-1)),s("span",gs,i(r.defaultCurrency)+" "+i(D.value.toFixed(2)),1)])])):m("",!0),n.length>0&&k.value?(a(),l("div",ks,[s("button",{onClick:Q,class:"btn btn-success btn-lg checkout-btn",disabled:u(w)},[u(w)?m("",!0):(a(),l("i",ws)),u(w)?(a(),l("span",qs)):m("",!0),y(" "+i(r.translations.continue),1)],8,Cs),s("div",{class:"quick-actions"},[s("button",{onClick:ut,class:"btn btn-outline-warning"},t[23]||(t[23]=[s("i",{class:"bi bi-pause-circle"},null,-1),y(" تعليق ")])),s("button",{onClick:ct,class:"btn btn-outline-info"},t[24]||(t[24]=[s("i",{class:"bi bi-printer"},null,-1),y(" طباعة ")]))])])):m("",!0)])]),S(wt,{translations:r.translations,show:u(g),total:D.value,defaultCurrency:r.defaultCurrency,onClose:t[5]||(t[5]=o=>U(g)?g.value=!1:g=!1),onConfirm:dt},null,8,["translations","show","total","defaultCurrency"]),u(E)?(a(),l("div",xs,t[25]||(t[25]=[s("div",{class:"shortcuts-content"},[s("h6",null,"اختصارات لوحة المفاتيح"),s("div",{class:"shortcut-item"},[s("kbd",null,"F1"),y(" - البحث ")]),s("div",{class:"shortcut-item"},[s("kbd",null,"F2"),y(" - الباركود ")]),s("div",{class:"shortcut-item"},[s("kbd",null,"F9"),y(" - الدفع ")]),s("div",{class:"shortcut-item"},[s("kbd",null,"Esc"),y(" - مسح الكل ")])],-1)]))):m("",!0)]),_:1},8,["translations"]))}},Ps=qt(Is,[["__scopeId","data-v-33f3cd64"]]);export{Ps as default};
