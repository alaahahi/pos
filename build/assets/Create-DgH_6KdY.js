import{l as w,T as E,m as B,h as I,p as H,q as R,c as z,w as L,o as v,b as t,t as l,a as f,d as S,e as G,N as $,u as i,i as q,x as C,S as J,f as h,F as W,s as X,g as V,L as A}from"./app-TgNgatPB.js";import{_ as Y}from"./AuthenticatedLayout-Dri-m7YE.js";import{_ as M}from"./InputError-q16GEmKj.js";import{C as P}from"./vue-select-6L0hGXJp.js";import"./sweetalert2.esm.all-DwEdJQJv.js";import{_ as Z}from"./ModalConfirmOrderAndPay-8n8ogfee.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const tt={class:"pagetitle dark:text-white"},et={class:"dark:text-white"},st={class:"breadcrumb"},ot={class:"breadcrumb-item"},at={class:"breadcrumb-item active dark:text-white"},nt={class:"section dashboard"},lt={class:"row"},rt={class:"col-lg-12"},it={class:"card"},dt={class:"card-body"},ct={class:"card-title"},ut={class:"row mb-3"},mt={for:"customerSelect",class:"col-sm-2 col-form-label"},pt={class:"col-sm-10"},vt={class:"row mb-3"},ft={for:"inputBarcode",class:"col-sm-2 col-form-label"},ht={class:"col-sm-10"},bt=["placeholder"],_t={key:0,class:"row mb-3"},yt={for:"productTable",class:"col-sm-2 col-form-label"},wt={class:"col-sm-10"},gt={class:"table"},xt=["onInput","onUpdate:modelValue","max"],kt=["onUpdate:modelValue"],qt=["value"],Ct=["onClick"],Vt={class:"row"},$t={class:"col-md-6"},Ut={class:"col-md-6"},Bt={class:"text-center"},It=["disabled"],Lt={key:0,class:"bi bi-save"},St={key:1,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},jt={__name:"Create",props:{products:Array,customers:Array,defaultCustomer:Object,translations:Object},setup(a){let U=w(""),b=w(!1),c=w(""),u=w(!1);const m=a,g=w(m.defaultCustomer.name),_=E({customer_id:m.defaultCustomer.id,items:[],log:[],total_amount:0}),p=B([]),D=B([]),N=I(()=>U.value?m.customers.filter(s=>{const e=U.value.toLowerCase();return s.name.toLowerCase().includes(e)||s.phone.includes(e)}):m.customers),O=s=>{const e=m.products.find(n=>n.id===s.product_id);e&&(s.price=e.price,s.max_quantity=e.max_quantity)},T=s=>{const e=m.products.find(n=>n.id===s.product_id);e&&s.quantity>e.max_quantity&&(s.quantity=e.max_quantity)},x=I(()=>p.reduce((s,e)=>s+e.quantity*e.price,0));H(x,s=>{_.total_amount=s});const y=s=>{const e=new Date().toLocaleString();D.push({message:s,timestamp:e})},j=()=>{p.push({product_id:"",quantity:1,price:0}),y("product_added")},F=s=>{p.splice(s,1),y("product_removed")},K=async s=>{b.value=!0;const e={total_amount:_.total_amount,total_paid:s.amountDollar,customer_id:_.customer_id,date:s.date,notes:s.notes,items:p.reduce((n,d)=>{let o=n.find(k=>k.product_id===d.product_id);return o?o.quantity+=d.quantity:n.push(d),n},[])};try{const n=await A.post("/api/createOrder",e);if(n.status===200||n.status===201){let d=n.data.id,o=n.data.order_id;window.open(`/api/getIndexAccountsSelas?print=2&transactions_id=${d}&order_id=${o}`,"_blank"),y("invoice_saved")}else y("invoice_save_failed")}catch(n){console.error("خطأ أثناء حفظ الفاتورة:",n),y("invoice_save_failed")}finally{b.value=!1}},Q=async()=>{if(c.value)try{const s=await A.get(`/api/products/${c.value}`);if(s.data.id){const e=p.find(n=>n.product_id===s.data.id);e?e.quantity+=1:p.push({product_id:s.data.id,quantity:1,price:s.data.price}),c.value="",console.log("تمت إضافة أو تحديث المنتج:",s.data)}}catch(s){console.error("خطأ أثناء البحث عن الباركود:",s)}};return(s,e)=>{const n=R("Link");return v(),z(Y,{translations:a.translations},{default:L(()=>{var d;return[t("div",tt,[t("h1",et,l(a.translations.invoice),1),t("nav",null,[t("ol",st,[t("li",ot,[f(n,{class:"nav-link dark:text-white",href:s.route("dashboard")},{default:L(()=>[S(l(a.translations.Home),1)]),_:1},8,["href"])]),t("li",at,l(a.translations.invoice),1)])])]),t("section",nt,[t("div",lt,[t("div",rt,[t("div",it,[t("div",dt,[t("h5",ct,l(a.translations.create_invoice),1),t("form",{onSubmit:e[5]||(e[5]=G(o=>$(u)?u.value=!0:u=!0,["prevent"])),class:"row g-3"},[t("div",ut,[t("label",mt,l(a.translations.client),1),t("div",pt,[f(i(P),{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=o=>g.value=o),options:N.value,label:"name","track-by":"id",reduce:o=>({id:o.id,name:o.name}),onBlur:e[1]||(e[1]=o=>s.mouseleave(g.value)),clearable:!0,placeholder:a.translations.select_customer},null,8,["modelValue","options","reduce","placeholder"]),f(M,{message:i(_).errors.customer},null,8,["message"])])]),t("div",vt,[t("label",ft,l(a.translations.barcode),1),t("div",ht,[q(t("input",{autofocus:"",id:"inputBarcode",type:"text",class:"form-control",placeholder:a.translations.barcode,onKeyup:e[2]||(e[2]=J(o=>Q(),["enter"])),"onUpdate:modelValue":e[3]||(e[3]=o=>$(c)?c.value=o:c=o)},null,40,bt),[[C,i(c)]]),f(M,{message:i(_).errors.name},null,8,["message"])])]),g.value?(v(),h("div",_t,[t("label",yt,l(a.translations.products),1),t("div",wt,[t("table",gt,[t("thead",null,[t("tr",null,[t("th",null,l(a.translations.product),1),t("th",null,l(a.translations.quantity),1),t("th",null,l(a.translations.price)+" "+l(a.translations.dollar),1),t("th",null,l(a.translations.total)+" "+l(a.translations.dollar),1),t("th",null,l(a.translations.actions),1)])]),t("tbody",null,[(v(!0),h(W,null,X(p,(o,k)=>(v(),h("tr",{key:k},[f(i(P),{modelValue:o.product_id,"onUpdate:modelValue":r=>o.product_id=r,options:a.products,label:"name",reduce:r=>r.id,placeholder:a.translations.select_product,class:"form-control",style:{"min-width":"200px"},onMouseleave:r=>O(o)},null,8,["modelValue","onUpdate:modelValue","options","reduce","placeholder","onMouseleave"]),t("td",null,[q(t("input",{type:"number",onInput:r=>T(o),"onUpdate:modelValue":r=>o.quantity=r,min:"1",max:o.max_quantity,class:"form-control",placeholder:"Quantity"},null,40,xt),[[C,o.quantity]])]),t("td",null,[q(t("input",{type:"number","onUpdate:modelValue":r=>o.price=r,min:"0",class:"form-control",placeholder:"Price"},null,8,kt),[[C,o.price]])]),t("td",null,[t("input",{type:"number",value:o.quantity*o.price,class:"form-control",disabled:""},null,8,qt)]),t("td",null,[t("button",{type:"button",class:"btn btn-danger",onClick:r=>F(k)},e[8]||(e[8]=[t("i",{class:"bi bi-trash"},null,-1)]),8,Ct)])]))),128))])]),(d=a.products)!=null&&d.length?(v(),h("button",{key:0,type:"button",class:"btn btn-primary",onClick:j},l(a.translations.add_product),1)):V("",!0)])])):V("",!0),t("div",Vt,[t("div",$t,[t("strong",null,l(m.translations.total)+" "+l(a.translations.dollar)+":",1)]),t("div",Ut,[q(t("input",{type:"number","onUpdate:modelValue":e[4]||(e[4]=o=>x.value=o),class:"form-control",readonly:""},null,512),[[C,x.value]])])]),t("div",Bt,[t("button",{type:"submit",class:"btn btn-primary",disabled:i(b)},[S(l(a.translations.save)+"   ",1),i(b)?V("",!0):(v(),h("i",Lt)),i(b)?(v(),h("span",St)):V("",!0)],8,It)])],32)])])])]),f(Z,{translations:a.translations,show:i(u),total:x.value,onClose:e[6]||(e[6]=o=>$(u)?u.value=!1:u=!1),onConfirm:e[7]||(e[7]=o=>K(o))},null,8,["translations","show","total"])])]}),_:1},8,["translations"])}}};export{jt as default};
