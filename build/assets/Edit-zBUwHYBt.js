import{l as g,T,m as k,h as O,p as j,q as E,c as F,w as $,o as c,b as t,t as n,a as p,d as q,e as H,u as x,f as m,F as Q,s as z,g as y,i as C,x as U,P as G}from"./app-BdCTErYV.js";import{_ as J}from"./AuthenticatedLayout-CbMAqcF_.js";import{_ as K}from"./InputError-1q4KRqEN.js";import{C as I}from"./vue-select-BV-Tc8Va.js";import{_ as R}from"./ModalConfirmOrderAndPay-B1SmSMwF.js";const W={class:"pagetitle"},X={class:"breadcrumb"},Y={class:"breadcrumb-item"},Z={class:"breadcrumb-item active"},tt={class:"section dashboard"},et={class:"row"},ot={class:"col-lg-12"},st={class:"card"},at={class:"card-body"},nt={class:"card-title"},lt={class:"row mb-3"},rt={for:"customerSelect",class:"col-sm-2 col-form-label"},dt={class:"col-sm-10"},it={key:0,class:"row mb-3"},ct={for:"productTable",class:"col-sm-2 col-form-label"},ut={class:"col-sm-10"},mt={class:"table"},vt=["onInput","onUpdate:modelValue","max"],_t=["onUpdate:modelValue"],bt=["value"],ht=["onClick"],pt={class:"row"},ft={class:"col-md-6"},yt={class:"col-md-6"},wt={class:"text-center"},Vt=["disabled"],gt={key:0,class:"bi bi-save"},kt={key:1,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},It={__name:"Edit",props:{order:Object,products:Array,customers:Array,translations:Object},setup(a){const v=g(!1),w=g(!1),d=a,_=g(d.customers.find(e=>e.id===d.order.customer_id)||null),i=T({id:d.order.id,customer_id:d.order.customer_id,items:d.order.items||[],total_amount:d.order.total_amount||0}),b=k(i.items);k([]);const h=O(()=>b.reduce((e,o)=>e+o.quantity*o.price,0));j(h,e=>{i.total_amount=e});const M=()=>{b.push({product_id:"",quantity:1,price:0,canadd:"true"})},P=e=>{b.splice(e,1)},A=e=>{const o=d.products.find(l=>l.id===e.product_id);o&&(e.price=o.price)},D=e=>{const o=d.products.find(l=>l.id===e.product_id);o&&e.quantity>o.max_quantity&&(e.quantity=o.max_quantity)},L=e=>{_.value=e,i.customer_id=e?e.id:null},S=()=>{w.value=!0},B=k([]),V=e=>{const o=new Date().toLocaleString();B.push({message:e,timestamp:o})},N=async e=>{v.value=!0;const o={total_amount:i.total_amount,total_paid:e.amountDollar,customer_id:i.customer_id,date:e.date,notes:e.notes,items:b.reduce((l,u)=>{let s=l.find(f=>f.product_id===u.product_id);return s?s.quantity+=u.quantity:l.push(u),l},[])};try{const l=await G.put(route("orders.update",i.id),o);l.status===200||l.status===201?(V("invoice_saved"),window.location.href="/orders"):V("invoice_save_failed")}catch(l){console.error("خطأ أثناء حفظ الفاتورة:",l),V("invoice_save_failed")}finally{v.value=!1}};return(e,o)=>{const l=E("Link");return c(),F(J,{translations:a.translations},{default:$(()=>{var u;return[t("div",W,[t("h1",null,n(a.translations.edit_order),1),t("nav",null,[t("ol",X,[t("li",Y,[p(l,{class:"nav-link",href:e.route("dashboard")},{default:$(()=>[q(n(a.translations.Home),1)]),_:1},8,["href"])]),t("li",Z,n(a.translations.edit_order),1)])])]),t("section",tt,[t("div",et,[t("div",ot,[t("div",st,[t("div",at,[t("h5",nt,n(a.translations.edit_order),1),t("form",{onSubmit:H(S,["prevent"]),class:"row g-3"},[t("div",lt,[t("label",rt,n(a.translations.client),1),t("div",dt,[p(x(I),{modelValue:_.value,"onUpdate:modelValue":o[0]||(o[0]=s=>_.value=s),options:a.customers,label:"name","track-by":"id",reduce:s=>({id:s.id,name:s.name}),clearable:!0,placeholder:a.translations.select_customer,onMouseleave:o[1]||(o[1]=s=>L(_.value))},null,8,["modelValue","options","reduce","placeholder"]),p(K,{message:x(i).errors.customer},null,8,["message"])])]),_.value?(c(),m("div",it,[t("label",ct,n(a.translations.products),1),t("div",ut,[t("table",mt,[t("thead",null,[t("tr",null,[t("th",null,n(a.translations.product),1),t("th",null,n(a.translations.quantity),1),t("th",null,n(a.translations.price),1),t("th",null,n(a.translations.total),1),t("th",null,n(a.translations.actions),1)])]),t("tbody",null,[(c(!0),m(Q,null,z(b,(s,f)=>(c(),m("tr",{key:f},[p(x(I),{modelValue:s.product_id,"onUpdate:modelValue":r=>s.product_id=r,options:a.products,label:"name",disabled:s.canadd!="true",reduce:r=>r.id,placeholder:a.translations.select_product,class:"form-control",style:{"min-width":"200px"},onMouseleave:r=>A(s)},null,8,["modelValue","onUpdate:modelValue","options","disabled","reduce","placeholder","onMouseleave"]),t("td",null,[C(t("input",{type:"number",onInput:r=>D(s),"onUpdate:modelValue":r=>s.quantity=r,min:"1",max:s.max_quantity,class:"form-control",placeholder:"Quantity"},null,40,vt),[[U,s.quantity]])]),t("td",null,[C(t("input",{type:"number","onUpdate:modelValue":r=>s.price=r,min:"0",class:"form-control",placeholder:"Price"},null,8,_t),[[U,s.price]])]),t("td",null,[t("input",{type:"number",value:s.quantity*s.price,class:"form-control",disabled:""},null,8,bt)]),t("td",null,[t("button",{type:"button",class:"btn btn-danger",onClick:r=>P(f)},o[5]||(o[5]=[t("i",{class:"bi bi-trash"},null,-1)]),8,ht)])]))),128))])]),(u=a.products)!=null&&u.length?(c(),m("button",{key:0,type:"button",class:"btn btn-primary",onClick:M},n(a.translations.add_product),1)):y("",!0)])])):y("",!0),t("div",pt,[t("div",ft,[t("strong",null,n(a.translations.total)+":",1)]),t("div",yt,[C(t("input",{type:"number","onUpdate:modelValue":o[2]||(o[2]=s=>h.value=s),class:"form-control",readonly:""},null,512),[[U,h.value]])])]),q(" "+n(h.value)+" ",1),t("div",wt,[t("button",{type:"submit",class:"btn btn-primary",disabled:v.value},[q(n(a.translations.save)+"   ",1),v.value?y("",!0):(c(),m("i",gt)),v.value?(c(),m("span",kt)):y("",!0)],8,Vt)])],32)])])])])]),p(R,{show:w.value,total:h.value,onClose:o[3]||(o[3]=s=>w.value=!1),onConfirm:o[4]||(o[4]=s=>N(s))},null,8,["show","total"])]}),_:1},8,["translations"])}}};export{It as default};
