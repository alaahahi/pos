import{l as P,m as g,T as S,q as j,h as F,B as R,E as k,C as H,o as d,c as z,w as x,b as t,t as l,a as h,d as V,e as G,u as c,f as p,F as J,x as K,i as C,s as I,g as w,I as Q}from"./app-DfrujaWl.js";import{_ as W}from"./AuthenticatedLayout-DGOyDvK1.js";import{_ as X}from"./InputError-cnsYrIBD.js";import{C as A}from"./vue-select-DIKJx49I.js";import{d as Y,_ as Z}from"./debounce-D4gz5gRq.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const tt={class:"pagetitle dark:text-white"},at={class:"dark:text-white"},et={class:"breadcrumb"},ot={class:"breadcrumb-item"},st={class:"breadcrumb-item"},nt={class:"breadcrumb-item active dark:text-white"},lt={class:"section dashboard"},it={class:"row"},rt={class:"col-lg-12"},dt={class:"card"},ct={class:"card-body"},ut={class:"card-title"},mt={class:"row mb-3"},ht={class:"col-sm-2 col-form-label"},pt={class:"col-sm-10"},_t={key:0,class:"row mb-3"},bt={class:"col-sm-2 col-form-label"},yt={class:"col-sm-10"},vt={class:"table"},ft={style:{"min-width":"200px"}},qt=["onUpdate:modelValue","onInput","max"],kt=["onUpdate:modelValue"],wt=["value","onInput"],gt=["onClick"],xt={class:"row"},Vt={class:"col-md-6"},Ct={class:"col-md-6"},It={class:"text-center mt-3"},$t=["disabled"],Ut={key:0,class:"bi bi-save"},At={key:1,class:"spinner-border spinner-border-sm"},Lt={__name:"Edit",props:{products:Array,all_products:Array,customers:Array,order:Object,translations:Object},setup(o){var $;let _=P();const r=o;let b=g(!1),u=g(!1);const m=S({id:r.order.id,customer_id:r.order.customer_id,items:r.order.items||[],total_amount:r.order.total_amount||0}),v=g(r.customers.find(a=>a.id===r.order.customer_id)||null),y=j((($=r.order.items)==null?void 0:$.map(a=>{var e;return{product_id:a.product_id,quantity:a.quantity,price:a.price,max_quantity:((e=r.products.find(s=>s.id===a.product_id))==null?void 0:e.max_quantity)||9999}}))||[]),B=a=>{v.value=a,m.customer_id=a?a.id:null},M=a=>{const e=r.products.find(s=>s.id===a.product_id);e&&(a.price=e.price,a.max_quantity=e.max_quantity)},D=a=>{const e=r.products.find(s=>s.id===a.product_id);e&&a.quantity>e.max_quantity&&(a.quantity=e.max_quantity)},N=()=>{y.push({product_id:"",quantity:1,price:0})},T=a=>{y.splice(a,1)},f=F(()=>y.reduce((a,e)=>a+e.quantity*e.price,0));R(f,a=>{m.total_amount=a});const E=()=>{u.value=!0},L=async a=>{b.value=!0;const e={total_amount:m.total_amount,total_paid:a.amountDollar??0,customer_id:m.customer_id,date:a.date,notes:a.notes,items:y.map(s=>({product_id:s.product_id,quantity:s.quantity,price:s.price}))};try{const s=await k.put(route("orders.update",m.id),e);(s.status===200||s.status===201)&&(window.location.href="/orders")}catch(s){console.error("خطأ أثناء تحديث الفاتورة:",s)}finally{b.value=!1,u.value=!1}};Y(async()=>{if(barcode.value)try{const a=await k.get(`/api/products/${barcode.value}`);if(a.data.id){const e=await k.get(`/api/check-stock/${a.data.id}`);if(e.data.available_quantity>0){const s=invoiceItems.find(q=>q.product_id===a.data.id);s?s.quantity+1<=e.data.available_quantity?s.quantity+=1:_.warning("لا توجد كمية كافية في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0}):invoiceItems.push({product_id:a.data.id,quantity:1,price:a.data.price}),barcode.value=""}else _.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}else _.error("تعذر تحقق من المنتج عن طريق الباركود",{timeout:5e3,position:"bottom-right",rtl:!0})}catch{_.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}},500);const O=async a=>{try{const e=await k.get(`/api/check-stock/${a.product_id}`);a.quantity>e.data.available_quantity&&(_.success(`الكمية المتوفرة فقط: ${e.data.available_quantity}`,{timeout:5e3,position:"bottom-right",rtl:!0}),a.quantity=e.data.available_quantity)}catch(e){console.error("خطأ عند التحقق من المخزون:",e)}};return(a,e)=>{const s=H("Link");return d(),z(W,{translations:o.translations},{default:x(()=>{var q;return[t("div",tt,[t("h1",at,l(o.translations.edit_invoice),1),t("nav",null,[t("ol",et,[t("li",ot,[h(s,{class:"nav-link dark:text-white",href:a.route("dashboard")},{default:x(()=>[V(l(o.translations.Home),1)]),_:1},8,["href"])]),t("li",st,[h(s,{class:"nav-link dark:text-white",href:a.route("orders.index")},{default:x(()=>[V(l(o.translations.invoices),1)]),_:1},8,["href"])]),t("li",nt,l(o.translations.edit_invoice),1)])])]),t("section",lt,[t("div",it,[t("div",rt,[t("div",dt,[t("div",ct,[t("h5",ut,l(o.translations.edit_invoice),1),t("form",{class:"row g-3",onSubmit:G(E,["prevent"])},[t("div",mt,[t("label",ht,l(o.translations.client),1),t("div",pt,[h(c(A),{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=n=>v.value=n),options:o.customers,label:"name","track-by":"id",reduce:n=>({id:n.id,name:n.name}),clearable:!0,placeholder:o.translations.select_customer,onInput:B},null,8,["modelValue","options","reduce","placeholder"]),h(X,{message:c(m).errors.customer_id},null,8,["message"])])]),v.value?(d(),p("div",_t,[t("label",bt,l(o.translations.products),1),t("div",yt,[t("table",vt,[t("thead",null,[t("tr",null,[t("th",null,l(o.translations.product),1),t("th",null,l(o.translations.quantity),1),t("th",null,l(o.translations.price)+" "+l(o.translations.dollar),1),t("th",null,l(o.translations.total)+" "+l(o.translations.dollar),1),t("th",null,l(o.translations.actions),1)])]),t("tbody",null,[(d(!0),p(J,null,K(y,(n,U)=>(d(),p("tr",{key:U},[t("td",ft,[h(c(A),{modelValue:n.product_id,"onUpdate:modelValue":i=>n.product_id=i,options:o.all_products,label:"name","track-by":"id",reduce:i=>i.id,placeholder:o.translations.select_product,class:"form-control",onInput:i=>M(n)},null,8,["modelValue","onUpdate:modelValue","options","reduce","placeholder","onInput"])]),t("td",null,[C(t("input",{type:"number","onUpdate:modelValue":i=>n.quantity=i,onInput:i=>D(n),min:"1",max:n.max_quantity,class:"form-control"},null,40,qt),[[I,n.quantity]])]),t("td",null,[C(t("input",{type:"number","onUpdate:modelValue":i=>n.price=i,min:"0",class:"form-control"},null,8,kt),[[I,n.price]])]),t("td",null,[t("input",{type:"number",value:n.quantity*n.price,class:"form-control",onInput:i=>O(n)},null,40,wt)]),t("td",null,[t("button",{type:"button",class:"btn btn-danger",onClick:i=>T(U)},e[3]||(e[3]=[t("i",{class:"bi bi-trash"},null,-1)]),8,gt)])]))),128))])]),(q=o.products)!=null&&q.length?(d(),p("button",{key:0,type:"button",class:"btn btn-primary",onClick:N},l(o.translations.add_product),1)):w("",!0)])])):w("",!0),t("div",xt,[t("div",Vt,[t("strong",null,l(o.translations.total)+" "+l(o.translations.dollar)+":",1)]),t("div",Ct,[C(t("input",{type:"number","onUpdate:modelValue":e[1]||(e[1]=n=>f.value=n),class:"form-control",readonly:""},null,512),[[I,f.value]])])]),t("div",It,[t("button",{type:"submit",class:"btn btn-primary",disabled:c(b)},[V(l(o.translations.save)+"   ",1),c(b)?w("",!0):(d(),p("i",Ut)),c(b)?(d(),p("span",At)):w("",!0)],8,$t)])],32)])])])]),h(Z,{translations:o.translations,show:c(u),total:f.value,onClose:e[2]||(e[2]=n=>Q(u)?u.value=!1:u=!1),onConfirm:L},null,8,["translations","show","total"])])]}),_:1},8,["translations"])}}};export{Lt as default};
