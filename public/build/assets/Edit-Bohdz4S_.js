import{s as E,r as x,T as L,z as S,k as F,B as R,E as q,C as z,a as d,h as H,w as g,b as t,t as i,i as h,d as C,j as G,u as c,c as p,F as J,f as K,l as V,x as I,e as w,I as Q}from"./app-DLChBEag.js";import{_ as W}from"./AuthenticatedLayout-BaBYr0b8.js";import{_ as X}from"./InputError-D0ouqqv7.js";import{C as M}from"./vue-select-Dka4tz16.js";import{d as Y,M as Z}from"./debounce-5Usw5is6.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const tt={class:"pagetitle dark:text-white"},at={class:"dark:text-white"},ot={class:"breadcrumb"},et={class:"breadcrumb-item"},st={class:"breadcrumb-item"},nt={class:"breadcrumb-item active dark:text-white"},it={class:"section dashboard"},lt={class:"row"},rt={class:"col-lg-12"},dt={class:"card"},ct={class:"card-body"},ut={class:"card-title"},mt={class:"row mb-3"},ht={class:"col-sm-2 col-form-label"},pt={class:"col-sm-10"},_t={key:0,class:"row mb-3"},bt={class:"col-sm-2 col-form-label"},yt={class:"col-sm-10"},ft={class:"table"},vt={style:{"min-width":"200px"}},kt=["onUpdate:modelValue","onInput","max"],qt=["onUpdate:modelValue"],wt=["value","onInput"],xt=["onClick"],gt={class:"row"},Ct={class:"col-md-6"},Vt={class:"col-md-6"},It={class:"text-center mt-3"},$t=["disabled"],Ut={key:0,class:"bi bi-save"},Mt={key:1,class:"spinner-border spinner-border-sm"},Tt={__name:"Edit",props:{products:Array,all_products:Array,customers:Array,order:Object,translations:Object},setup(e){var $;let _=E();const r=e;let b=x(!1),u=x(!1);const m=L({id:r.order.id,customer_id:r.order.customer_id,items:r.order.items||[],total_amount:r.order.total_amount||0}),f=x(r.customers.find(a=>a.id===r.order.customer_id)||null),y=S((($=r.order.items)==null?void 0:$.map(a=>{var o;return{product_id:a.product_id,quantity:a.quantity,price:a.price,max_quantity:((o=r.products.find(s=>s.id===a.product_id))==null?void 0:o.max_quantity)||9999}}))||[]),A=a=>{f.value=a,m.customer_id=a?a.id:null},B=a=>{const o=r.products.find(s=>s.id===a.product_id);o&&(a.price=o.price,a.max_quantity=o.max_quantity)},D=a=>{const o=r.products.find(s=>s.id===a.product_id);o&&a.quantity>o.max_quantity&&(a.quantity=o.max_quantity)},N=()=>{y.push({product_id:"",quantity:1,price:0})},O=a=>{y.splice(a,1)},v=F(()=>y.reduce((a,o)=>a+o.quantity*o.price,0));R(v,a=>{m.total_amount=a});const P=()=>{u.value=!0},T=async a=>{b.value=!0;const o={total_amount:m.total_amount,total_paid:a.amountDollar??0,customer_id:m.customer_id,date:a.date,notes:a.notes,discount_amount:a.discount_amount??0,discount_rate:a.discount_rate??0,items:y.map(s=>({product_id:s.product_id,quantity:s.quantity,price:s.price}))};try{const s=await q.put(route("orders.update",m.id),o);(s.status===200||s.status===201)&&(window.location.href="/orders")}catch(s){console.error("خطأ أثناء تحديث الفاتورة:",s)}finally{b.value=!1,u.value=!1}};Y(async()=>{if(barcode.value)try{const a=await q.get(`/api/products/${barcode.value}`);if(a.data.id){const o=await q.get(`/api/check-stock/${a.data.id}`);if(o.data.available_quantity>0){const s=invoiceItems.find(k=>k.product_id===a.data.id);s?s.quantity+1<=o.data.available_quantity?s.quantity+=1:_.warning("لا توجد كمية كافية في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0}):invoiceItems.push({product_id:a.data.id,quantity:1,price:a.data.price}),barcode.value=""}else _.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}else _.error("تعذر تحقق من المنتج عن طريق الباركود",{timeout:5e3,position:"bottom-right",rtl:!0})}catch{_.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}},500);const j=async a=>{try{const o=await q.get(`/api/check-stock/${a.product_id}`);a.quantity>o.data.available_quantity&&(_.success(`الكمية المتوفرة فقط: ${o.data.available_quantity}`,{timeout:5e3,position:"bottom-right",rtl:!0}),a.quantity=o.data.available_quantity)}catch(o){console.error("خطأ عند التحقق من المخزون:",o)}};return(a,o)=>{const s=z("Link");return d(),H(W,{translations:e.translations},{default:g(()=>{var k;return[t("div",tt,[t("h1",at,i(e.translations.edit_invoice),1),t("nav",null,[t("ol",ot,[t("li",et,[h(s,{class:"nav-link dark:text-white",href:a.route("dashboard")},{default:g(()=>[C(i(e.translations.Home),1)]),_:1},8,["href"])]),t("li",st,[h(s,{class:"nav-link dark:text-white",href:a.route("orders.index")},{default:g(()=>[C(i(e.translations.invoices),1)]),_:1},8,["href"])]),t("li",nt,i(e.translations.edit_invoice),1)])])]),t("section",it,[t("div",lt,[t("div",rt,[t("div",dt,[t("div",ct,[t("h5",ut,i(e.translations.edit_invoice),1),t("form",{class:"row g-3",onSubmit:G(P,["prevent"])},[t("div",mt,[t("label",ht,i(e.translations.client),1),t("div",pt,[h(c(M),{modelValue:f.value,"onUpdate:modelValue":o[0]||(o[0]=n=>f.value=n),options:e.customers,label:"name","track-by":"id",reduce:n=>({id:n.id,name:n.name}),clearable:!0,placeholder:e.translations.select_customer,onInput:A},null,8,["modelValue","options","reduce","placeholder"]),h(X,{message:c(m).errors.customer_id},null,8,["message"])])]),f.value?(d(),p("div",_t,[t("label",bt,i(e.translations.products),1),t("div",yt,[t("table",ft,[t("thead",null,[t("tr",null,[t("th",null,i(e.translations.product),1),t("th",null,i(e.translations.quantity),1),t("th",null,i(e.translations.price)+" "+i(e.translations.dollar),1),t("th",null,i(e.translations.total)+" "+i(e.translations.dollar),1),t("th",null,i(e.translations.actions),1)])]),t("tbody",null,[(d(!0),p(J,null,K(y,(n,U)=>(d(),p("tr",{key:U},[t("td",vt,[h(c(M),{modelValue:n.product_id,"onUpdate:modelValue":l=>n.product_id=l,options:e.all_products,label:"name","track-by":"id",reduce:l=>l.id,placeholder:e.translations.select_product,class:"form-control",onInput:l=>B(n)},null,8,["modelValue","onUpdate:modelValue","options","reduce","placeholder","onInput"])]),t("td",null,[V(t("input",{type:"number","onUpdate:modelValue":l=>n.quantity=l,onInput:l=>D(n),min:"1",max:n.max_quantity,class:"form-control"},null,40,kt),[[I,n.quantity]])]),t("td",null,[V(t("input",{type:"number","onUpdate:modelValue":l=>n.price=l,min:"0",class:"form-control"},null,8,qt),[[I,n.price]])]),t("td",null,[t("input",{type:"number",value:n.quantity*n.price,class:"form-control",onInput:l=>j(n)},null,40,wt)]),t("td",null,[t("button",{type:"button",class:"btn btn-danger",onClick:l=>O(U)},o[3]||(o[3]=[t("i",{class:"bi bi-trash"},null,-1)]),8,xt)])]))),128))])]),(k=e.products)!=null&&k.length?(d(),p("button",{key:0,type:"button",class:"btn btn-primary",onClick:N},i(e.translations.add_product),1)):w("",!0)])])):w("",!0),t("div",gt,[t("div",Ct,[t("strong",null,i(e.translations.total)+" "+i(e.translations.dollar)+":",1)]),t("div",Vt,[V(t("input",{type:"number","onUpdate:modelValue":o[1]||(o[1]=n=>v.value=n),class:"form-control",readonly:""},null,512),[[I,v.value]])])]),t("div",It,[t("button",{type:"submit",class:"btn btn-primary",disabled:c(b)},[C(i(e.translations.save)+"   ",1),c(b)?w("",!0):(d(),p("i",Ut)),c(b)?(d(),p("span",Mt)):w("",!0)],8,$t)])],32)])])])]),h(Z,{translations:e.translations,show:c(u),total:v.value,onClose:o[2]||(o[2]=n=>Q(u)?u.value=!1:u=!1),onConfirm:T},null,8,["translations","show","total"])])]}),_:1},8,["translations"])}}};export{Tt as default};
