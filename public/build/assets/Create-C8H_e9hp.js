import{l as w,T as H,m as B,h as I,p as K,q as R,c as z,w as L,o as v,b as t,t as l,a as f,d as A,e as G,N as $,u as i,i as q,x as C,f as h,F as J,s as W,g as V,L as M}from"./app-BCTch7Ty.js";import{_ as X}from"./AuthenticatedLayout-DzpsqyHG.js";import{_ as P}from"./InputError-BuEKVW1D.js";import{C as S}from"./vue-select-Dxn_miWB.js";import"./sweetalert2.esm.all-DwEdJQJv.js";import{_ as Y}from"./ModalConfirmOrderAndPay-BGIl5ikp.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"pagetitle dark:text-white"},tt={class:"dark:text-white"},et={class:"breadcrumb"},ot={class:"breadcrumb-item"},st={class:"breadcrumb-item active dark:text-white"},at={class:"section dashboard"},nt={class:"row"},lt={class:"col-lg-12"},rt={class:"card"},it={class:"card-body"},dt={class:"card-title"},ct={class:"row mb-3"},ut={for:"customerSelect",class:"col-sm-2 col-form-label"},mt={class:"col-sm-10"},pt={class:"row mb-3"},vt={for:"inputBarcode",class:"col-sm-2 col-form-label"},ft={class:"col-sm-10"},ht=["placeholder"],bt={key:0,class:"row mb-3"},_t={for:"productTable",class:"col-sm-2 col-form-label"},yt={class:"col-sm-10"},wt={class:"table"},gt=["onInput","onUpdate:modelValue","max"],xt=["onUpdate:modelValue"],kt=["value"],qt=["onClick"],Ct={class:"row"},Vt={class:"col-md-6"},$t={class:"col-md-6"},Ut={class:"text-center"},Bt=["disabled"],It={key:0,class:"bi bi-save"},Lt={key:1,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},Tt={__name:"Create",props:{products:Array,customers:Array,defaultCustomer:Object,translations:Object},setup(a){let U=w(""),b=w(!1),c=w(""),u=w(!1);const m=a,g=w(m.defaultCustomer.name),_=H({customer_id:m.defaultCustomer.id,items:[],log:[],total_amount:0}),p=B([]),D=B([]),N=I(()=>U.value?m.customers.filter(o=>{const e=U.value.toLowerCase();return o.name.toLowerCase().includes(e)||o.phone.includes(e)}):m.customers),O=o=>{const e=m.products.find(n=>n.id===o.product_id);e&&(o.price=e.price,o.max_quantity=e.max_quantity)},T=o=>{const e=m.products.find(n=>n.id===o.product_id);e&&o.quantity>e.max_quantity&&(o.quantity=e.max_quantity)},x=I(()=>p.reduce((o,e)=>o+e.quantity*e.price,0));K(x,o=>{_.total_amount=o});const y=o=>{const e=new Date().toLocaleString();D.push({message:o,timestamp:e})},j=()=>{p.push({product_id:"",quantity:1,price:0}),y("product_added")},F=o=>{p.splice(o,1),y("product_removed")},Q=async o=>{b.value=!0;const e={total_amount:_.total_amount,total_paid:o.amountDollar,customer_id:_.customer_id,date:o.date,notes:o.notes,items:p.reduce((n,d)=>{let s=n.find(k=>k.product_id===d.product_id);return s?s.quantity+=d.quantity:n.push(d),n},[])};try{const n=await M.post("/api/createOrder",e);if(n.status===200||n.status===201){let d=n.data.id,s=n.data.order_id;window.open(`/api/getIndexAccountsSelas?print=2&transactions_id=${d}&order_id=${s}`,"_blank"),y("invoice_saved")}else y("invoice_save_failed")}catch(n){console.error("خطأ أثناء حفظ الفاتورة:",n),y("invoice_save_failed")}finally{b.value=!1}},E=async()=>{if(c.value)try{const o=await M.get(`/api/products/${c.value}`);if(o.data.id){const e=p.find(n=>n.product_id===o.data.id);e?e.quantity+=1:p.push({product_id:o.data.id,quantity:1,price:o.data.price}),c.value="",console.log("تمت إضافة أو تحديث المنتج:",o.data)}}catch(o){console.error("خطأ أثناء البحث عن الباركود:",o)}};return(o,e)=>{const n=R("Link");return v(),z(X,{translations:a.translations},{default:L(()=>{var d;return[t("div",Z,[t("h1",tt,l(a.translations.invoice),1),t("nav",null,[t("ol",et,[t("li",ot,[f(n,{class:"nav-link dark:text-white",href:o.route("dashboard")},{default:L(()=>[A(l(a.translations.Home),1)]),_:1},8,["href"])]),t("li",st,l(a.translations.invoice),1)])])]),t("section",at,[t("div",nt,[t("div",lt,[t("div",rt,[t("div",it,[t("h5",dt,l(a.translations.create_invoice),1),t("form",{onSubmit:e[5]||(e[5]=G(s=>$(u)?u.value=!0:u=!0,["prevent"])),class:"row g-3"},[t("div",ct,[t("label",ut,l(a.translations.client),1),t("div",mt,[f(i(S),{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=s=>g.value=s),options:N.value,label:"name","track-by":"id",reduce:s=>({id:s.id,name:s.name}),onBlur:e[1]||(e[1]=s=>o.mouseleave(g.value)),clearable:!0,placeholder:a.translations.select_customer},null,8,["modelValue","options","reduce","placeholder"]),f(P,{message:i(_).errors.customer},null,8,["message"])])]),t("div",pt,[t("label",vt,l(a.translations.barcode),1),t("div",ft,[q(t("input",{autofocus:"",id:"inputBarcode",type:"text",class:"form-control",placeholder:a.translations.barcode,onKeyup:e[2]||(e[2]=s=>E()),"onUpdate:modelValue":e[3]||(e[3]=s=>$(c)?c.value=s:c=s)},null,40,ht),[[C,i(c)]]),f(P,{message:i(_).errors.name},null,8,["message"])])]),g.value?(v(),h("div",bt,[t("label",_t,l(a.translations.products),1),t("div",yt,[t("table",wt,[t("thead",null,[t("tr",null,[t("th",null,l(a.translations.product),1),t("th",null,l(a.translations.quantity),1),t("th",null,l(a.translations.price)+" "+l(a.translations.dollar),1),t("th",null,l(a.translations.total)+" "+l(a.translations.dollar),1),t("th",null,l(a.translations.actions),1)])]),t("tbody",null,[(v(!0),h(J,null,W(p,(s,k)=>(v(),h("tr",{key:k},[f(i(S),{modelValue:s.product_id,"onUpdate:modelValue":r=>s.product_id=r,options:a.products,label:"name",reduce:r=>r.id,placeholder:a.translations.select_product,class:"form-control",style:{"min-width":"200px"},onMouseleave:r=>O(s)},null,8,["modelValue","onUpdate:modelValue","options","reduce","placeholder","onMouseleave"]),t("td",null,[q(t("input",{type:"number",onInput:r=>T(s),"onUpdate:modelValue":r=>s.quantity=r,min:"1",max:s.max_quantity,class:"form-control",placeholder:"Quantity"},null,40,gt),[[C,s.quantity]])]),t("td",null,[q(t("input",{type:"number","onUpdate:modelValue":r=>s.price=r,min:"0",class:"form-control",placeholder:"Price"},null,8,xt),[[C,s.price]])]),t("td",null,[t("input",{type:"number",value:s.quantity*s.price,class:"form-control",disabled:""},null,8,kt)]),t("td",null,[t("button",{type:"button",class:"btn btn-danger",onClick:r=>F(k)},e[8]||(e[8]=[t("i",{class:"bi bi-trash"},null,-1)]),8,qt)])]))),128))])]),(d=a.products)!=null&&d.length?(v(),h("button",{key:0,type:"button",class:"btn btn-primary",onClick:j},l(a.translations.add_product),1)):V("",!0)])])):V("",!0),t("div",Ct,[t("div",Vt,[t("strong",null,l(m.translations.total)+" "+l(a.translations.dollar)+":",1)]),t("div",$t,[q(t("input",{type:"number","onUpdate:modelValue":e[4]||(e[4]=s=>x.value=s),class:"form-control",readonly:""},null,512),[[C,x.value]])])]),t("div",Ut,[t("button",{type:"submit",class:"btn btn-primary",disabled:i(b)},[A(l(a.translations.save)+"   ",1),i(b)?V("",!0):(v(),h("i",It)),i(b)?(v(),h("span",Lt)):V("",!0)],8,Bt)])],32)])])])]),f(Y,{translations:a.translations,show:i(u),total:x.value,onClose:e[6]||(e[6]=s=>$(u)?u.value=!1:u=!1),onConfirm:e[7]||(e[7]=s=>Q(s))},null,8,["translations","show","total"])])]}),_:1},8,["translations"])}}};export{Tt as default};
