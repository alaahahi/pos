import{y as E,l as k,T as F,m as R,h as H,p as K,A as g,q as z,o as d,c as G,w as A,b as t,t as n,a as _,d as B,e as J,u as r,i as x,x as V,E as M,f as m,F as Q,s as W,g as y}from"./app-CupeuroJ.js";import{_ as X}from"./AuthenticatedLayout-BoGgqcxh.js";import{_ as Y}from"./InputError-BZhlydFI.js";import{C as S}from"./vue-select-jSq78gww.js";import{d as Z,_ as tt}from"./debounce-1YENCzBN.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const et={class:"pagetitle dark:text-white"},ot={class:"dark:text-white"},at={class:"breadcrumb"},st={class:"breadcrumb-item"},nt={class:"breadcrumb-item active dark:text-white"},lt={class:"section dashboard"},it={class:"row"},rt={class:"col-lg-12"},ct={class:"card"},dt={class:"card-body"},ut={class:"card-title"},mt={class:"row mb-3"},ht={class:"col-sm-2 col-form-label"},bt={class:"col-sm-10"},pt={class:"row mb-3"},ft={class:"col-sm-2 col-form-label"},vt={class:"col-sm-10"},_t=["placeholder"],yt={key:0,class:"row mb-3"},wt={class:"col-sm-2 col-form-label"},kt={class:"col-sm-10"},gt={class:"table"},Ct={style:{"min-width":"200px"}},qt=["onUpdate:modelValue","onInput"],xt=["onUpdate:modelValue"],Vt=["value"],$t=["onClick"],It={class:"row"},Ut={class:"col-md-6"},At={class:"col-md-6"},Bt=["value"],Mt={key:1,class:"text-center mt-3"},St=["disabled"],Dt={key:0,class:"bi bi-save"},Nt={key:1,class:"spinner-border spinner-border-sm"},Ft={__name:"Create",props:{products:Array,customers:Array,defaultCustomer:Object,translations:Object,defaultCurrency:String},setup(o){var I;let h=E(),f=k(!1),u=k(""),b=k(!1);const C=o,w=k(C.defaultCustomer),v=F({customer_id:((I=C.defaultCustomer)==null?void 0:I.id)||null,total_amount:0}),c=R([]),q=H(()=>c.reduce((e,a)=>e+a.quantity*a.price,0));K(q,e=>{v.total_amount=e});const D=e=>{w.value=e,v.customer_id=e?e.id:null},N=e=>{const a=C.products.find(l=>l.id===e.product_id);a&&(e.price=a.price)},O=()=>{c.push({product_id:"",quantity:1,price:0})},P=e=>{c.splice(e,1)},T=()=>{b.value=!0},L=async e=>{f.value=!0;const a={total_amount:v.total_amount,total_paid:e.amountDollar??0,customer_id:v.customer_id,date:e.date,notes:e.notes,items:c.map(l=>({product_id:l.product_id,quantity:l.quantity,price:l.price}))};try{const l=await g.post("/api/createOrder",a);if(l.status===200||l.status===201){let{id:p,order_id:s}=l.data;e.printInvoice?window.open(`/api/getIndexAccountsSelas?print=2&transactions_id=${p}&order_id=${s}`,"_blank"):window.location.href="/orders/create"}}catch{h.error("خطأ أثناء حفظ الفاتورة",{timeout:5e3,position:"bottom-right",rtl:!0})}finally{f.value=!1,b.value=!1}},$=Z(async()=>{if(u.value)try{const e=await g.get(`/api/products/${u.value}`);if(e.data.id){const a=await g.get(`/api/check-stock/${e.data.id}`);if(a.data.available_quantity>0){const l=c.find(p=>p.product_id===e.data.id);l?l.quantity+1<=a.data.available_quantity?l.quantity+=1:h.warning("لا توجد كمية كافية في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0}):c.push({product_id:e.data.id,quantity:1,price:e.data.price}),u.value=""}else h.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}else h.error("تعذر تحقق من المنتج عن طريق الباركود",{timeout:5e3,position:"bottom-right",rtl:!0})}catch{h.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}},500),j=async e=>{try{const a=await g.get(`/api/check-stock/${e.product_id}`);e.quantity>a.data.available_quantity&&(h.success(`الكمية المتوفرة فقط: ${a.data.available_quantity}`,{timeout:5e3,position:"bottom-right",rtl:!0}),e.quantity=a.data.available_quantity)}catch(a){console.error("خطأ عند التحقق من المخزون:",a)}};return(e,a)=>{const l=z("Link");return d(),G(X,{translations:o.translations},{default:A(()=>{var p;return[t("div",et,[t("h1",ot,n(o.translations.invoice),1),t("nav",null,[t("ol",at,[t("li",st,[_(l,{class:"nav-link dark:text-white",href:e.route("dashboard")},{default:A(()=>[B(n(o.translations.Home),1)]),_:1},8,["href"])]),t("li",nt,n(o.translations.invoice),1)])])]),t("section",lt,[t("div",it,[t("div",rt,[t("div",ct,[t("div",dt,[t("h5",ut,n(o.translations.create_invoice),1),t("form",{class:"row g-3",onSubmit:J(T,["prevent"])},[t("div",mt,[t("label",ht,n(o.translations.client),1),t("div",bt,[_(r(S),{modelValue:w.value,"onUpdate:modelValue":a[0]||(a[0]=s=>w.value=s),options:o.customers,label:"name","track-by":"id",reduce:s=>s,onInput:D,placeholder:o.translations.select_customer},null,8,["modelValue","options","reduce","placeholder"]),_(Y,{message:r(v).errors.customer_id},null,8,["message"])])]),t("div",pt,[t("label",ft,n(o.translations.barcode),1),t("div",vt,[x(t("input",{id:"inputBarcode",type:"text",class:"form-control",placeholder:o.translations.barcode,"onUpdate:modelValue":a[1]||(a[1]=s=>M(u)?u.value=s:u=s),onKeyup:a[2]||(a[2]=(...s)=>r($)&&r($)(...s))},null,40,_t),[[V,r(u)]])])]),w.value?(d(),m("div",yt,[t("label",wt,n(o.translations.products),1),t("div",kt,[t("table",gt,[t("thead",null,[t("tr",null,[t("th",null,n(o.translations.product),1),t("th",null,n(o.translations.quantity),1),t("th",null,n(o.translations.price)+" "+n(o.translations.dollar),1),t("th",null,n(o.translations.total)+" "+n(o.translations.dollar),1),t("th",null,n(o.translations.actions),1)])]),t("tbody",null,[(d(!0),m(Q,null,W(c,(s,U)=>(d(),m("tr",{key:U},[t("td",Ct,[_(r(S),{modelValue:s.product_id,"onUpdate:modelValue":i=>s.product_id=i,options:o.products,label:"name",reduce:i=>i.id,placeholder:o.translations.select_product,onMouseleave:i=>N(s)},null,8,["modelValue","onUpdate:modelValue","options","reduce","placeholder","onMouseleave"])]),t("td",null,[x(t("input",{type:"number","onUpdate:modelValue":i=>s.quantity=i,min:"1",class:"form-control",onInput:i=>j(s)},null,40,qt),[[V,s.quantity,void 0,{number:!0}]])]),t("td",null,[x(t("input",{type:"number","onUpdate:modelValue":i=>s.price=i,min:"0",class:"form-control"},null,8,xt),[[V,s.price,void 0,{number:!0}]])]),t("td",null,[t("input",{type:"text",value:o.defaultCurrency+" "+s.quantity*s.price,class:"form-control",disabled:""},null,8,Vt)]),t("td",null,[t("button",{type:"button",class:"btn btn-danger",onClick:i=>P(U)},a[4]||(a[4]=[t("i",{class:"bi bi-trash"},null,-1)]),8,$t)])]))),128))])]),(p=o.products)!=null&&p.length?(d(),m("button",{key:0,type:"button",class:"btn btn-primary",onClick:O},n(o.translations.add_product),1)):y("",!0)])])):y("",!0),t("div",It,[t("div",Ut,[t("strong",null,n(o.translations.total)+" "+n(o.translations.dollar)+":",1)]),t("div",At,[t("input",{type:"text",value:o.defaultCurrency+" "+q.value,class:"form-control",readonly:""},null,8,Bt)])]),c.length>0?(d(),m("div",Mt,[t("button",{type:"submit",class:"btn btn-info w-75 text-center text-white",disabled:r(f)},[B(n(o.translations.continue)+"   ",1),r(f)?y("",!0):(d(),m("i",Dt)),r(f)?(d(),m("span",Nt)):y("",!0)],8,St)])):y("",!0)],32)])])])]),_(tt,{translations:o.translations,show:r(b),total:q.value,onClose:a[3]||(a[3]=s=>M(b)?b.value=!1:b=!1),onConfirm:L},null,8,["translations","show","total"])])]}),_:1},8,["translations"])}}};export{Ft as default};
