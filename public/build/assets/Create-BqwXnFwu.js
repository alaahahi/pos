import{l as F,m as g,T as R,q as H,h as J,B as z,E as C,C as G,o as c,c as Q,w as B,b as t,t as n,a as y,d as M,e as A,J as S,u as i,i as V,s as $,I as D,f as m,F as W,x as X,g as _}from"./app-DfrujaWl.js";import{_ as Y}from"./AuthenticatedLayout-DGOyDvK1.js";import{_ as Z}from"./InputError-cnsYrIBD.js";import{C as N}from"./vue-select-DIKJx49I.js";import{d as tt,_ as et}from"./debounce-D4gz5gRq.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ot={class:"pagetitle dark:text-white"},st={class:"dark:text-white"},at={class:"breadcrumb"},nt={class:"breadcrumb-item"},lt={class:"breadcrumb-item active dark:text-white"},it={class:"section dashboard"},rt={class:"row"},dt={class:"col-lg-12"},ct={class:"card"},ut={class:"card-body"},mt={class:"card-title"},ht={class:"row mb-3"},bt={class:"col-sm-2 col-form-label"},pt={class:"col-sm-10"},vt={class:"row mb-3"},ft={class:"col-sm-2 col-form-label"},yt={class:"col-sm-10"},_t=["placeholder"],wt={key:0,class:"row mb-3"},kt={class:"col-sm-2 col-form-label"},gt={class:"col-sm-10"},Ct={class:"table"},qt={style:{"min-width":"200px"}},xt=["onUpdate:modelValue","onInput"],Vt=["onUpdate:modelValue"],$t=["value"],It=["onClick"],Ut={class:"row"},Bt={class:"col-md-6"},Mt={class:"col-md-6"},At=["value"],St={key:1,class:"text-center mt-3"},Dt=["disabled"],Nt={key:0,class:"bi bi-save"},Ot={key:1,class:"spinner-border spinner-border-sm"},Ft={__name:"Create",props:{products:Array,customers:Array,defaultCustomer:Object,translations:Object,defaultCurrency:String},setup(s){var I;let h=F(),v=g(!1),u=g(""),b=g(!1);const q=s,w=g(q.defaultCustomer),f=R({customer_id:((I=q.defaultCustomer)==null?void 0:I.id)||null,total_amount:0}),d=H([]),x=J(()=>d.reduce((o,e)=>o+e.quantity*e.price,0));z(x,o=>{f.total_amount=o});const O=o=>{w.value=o,f.customer_id=o?o.id:null},P=o=>{const e=q.products.find(l=>l.id===o.product_id);e&&(o.price=e.price)},T=()=>{d.push({product_id:"",quantity:1,price:0})},K=o=>{d.splice(o,1)},L=()=>{b.value=!0},j=async o=>{v.value=!0;const e={total_amount:f.total_amount,total_paid:o.amountDollar??0,customer_id:f.customer_id,date:o.date,notes:o.notes,items:d.map(l=>({product_id:l.product_id,quantity:l.quantity,price:l.price}))};try{const l=await C.post("/api/createOrder",e);if(l.status===200||l.status===201){let{id:p,order_id:a}=l.data;o.printInvoice?window.open(`/api/getIndexAccountsSelas?print=2&transactions_id=${p}&order_id=${a}`,"_blank"):window.location.href="/orders/create"}}catch{h.error("خطأ أثناء حفظ الفاتورة",{timeout:5e3,position:"bottom-right",rtl:!0})}finally{v.value=!1,b.value=!1}},k=tt(async()=>{if(u.value)try{const o=await C.get(`/api/products/${u.value}`);if(o.data.id){const e=await C.get(`/api/check-stock/${o.data.id}`);if(e.data.available_quantity>0){const l=d.find(p=>p.product_id===o.data.id);l?l.quantity+1<=e.data.available_quantity?l.quantity+=1:h.warning("لا توجد كمية كافية في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0}):d.push({product_id:o.data.id,quantity:1,price:o.data.price}),u.value=""}else h.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}else h.error("تعذر تحقق من المنتج عن طريق الباركود",{timeout:5e3,position:"bottom-right",rtl:!0})}catch{h.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}},500),E=async o=>{try{const e=await C.get(`/api/check-stock/${o.product_id}`);o.quantity>e.data.available_quantity&&(h.success(`الكمية المتوفرة فقط: ${e.data.available_quantity}`,{timeout:5e3,position:"bottom-right",rtl:!0}),o.quantity=e.data.available_quantity)}catch(e){console.error("خطأ عند التحقق من المخزون:",e)}};return(o,e)=>{const l=G("Link");return c(),Q(Y,{translations:s.translations},{default:B(()=>{var p;return[t("div",ot,[t("h1",st,n(s.translations.invoice),1),t("nav",null,[t("ol",at,[t("li",nt,[y(l,{class:"nav-link dark:text-white",href:o.route("dashboard")},{default:B(()=>[M(n(s.translations.Home),1)]),_:1},8,["href"])]),t("li",lt,n(s.translations.invoice),1)])])]),t("section",it,[t("div",rt,[t("div",dt,[t("div",ct,[t("div",ut,[t("h5",mt,n(s.translations.create_invoice),1),t("form",{class:"row g-3",onSubmit:A(L,["prevent"]),onKeydown:e[4]||(e[4]=S(A(()=>{},["prevent"]),["enter"]))},[t("div",ht,[t("label",bt,n(s.translations.client),1),t("div",pt,[y(i(N),{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=a=>w.value=a),options:s.customers,label:"name","track-by":"id",reduce:a=>a,onInput:O,placeholder:s.translations.select_customer},null,8,["modelValue","options","reduce","placeholder"]),y(Z,{message:i(f).errors.customer_id},null,8,["message"])])]),t("div",vt,[t("label",ft,n(s.translations.barcode),1),t("div",yt,[V(t("input",{id:"inputBarcode",type:"text",class:"form-control",placeholder:s.translations.barcode,"onUpdate:modelValue":e[1]||(e[1]=a=>D(u)?u.value=a:u=a),onKeyup:[e[2]||(e[2]=(...a)=>i(k)&&i(k)(...a)),e[3]||(e[3]=S((...a)=>i(k)&&i(k)(...a),["enter"]))]},null,40,_t),[[$,i(u)]])])]),w.value?(c(),m("div",wt,[t("label",kt,n(s.translations.products),1),t("div",gt,[t("table",Ct,[t("thead",null,[t("tr",null,[t("th",null,n(s.translations.product),1),t("th",null,n(s.translations.quantity),1),t("th",null,n(s.translations.price)+" "+n(s.translations.dollar),1),t("th",null,n(s.translations.total)+" "+n(s.translations.dollar),1),t("th",null,n(s.translations.actions),1)])]),t("tbody",null,[(c(!0),m(W,null,X(d,(a,U)=>(c(),m("tr",{key:U},[t("td",qt,[y(i(N),{modelValue:a.product_id,"onUpdate:modelValue":r=>a.product_id=r,options:s.products,label:"name",reduce:r=>r.id,placeholder:s.translations.select_product,onMouseleave:r=>P(a)},null,8,["modelValue","onUpdate:modelValue","options","reduce","placeholder","onMouseleave"])]),t("td",null,[V(t("input",{type:"number","onUpdate:modelValue":r=>a.quantity=r,min:"1",class:"form-control",onInput:r=>E(a)},null,40,xt),[[$,a.quantity,void 0,{number:!0}]])]),t("td",null,[V(t("input",{type:"number","onUpdate:modelValue":r=>a.price=r,min:"0",class:"form-control"},null,8,Vt),[[$,a.price,void 0,{number:!0}]])]),t("td",null,[t("input",{type:"text",value:s.defaultCurrency+" "+a.quantity*a.price,class:"form-control",disabled:""},null,8,$t)]),t("td",null,[t("button",{type:"button",class:"btn btn-danger",onClick:r=>K(U)},e[6]||(e[6]=[t("i",{class:"bi bi-trash"},null,-1)]),8,It)])]))),128))])]),(p=s.products)!=null&&p.length?(c(),m("button",{key:0,type:"button",class:"btn btn-primary",onClick:T},n(s.translations.add_product),1)):_("",!0)])])):_("",!0),t("div",Ut,[t("div",Bt,[t("strong",null,n(s.translations.total)+" "+n(s.translations.dollar)+":",1)]),t("div",Mt,[t("input",{type:"text",value:s.defaultCurrency+" "+x.value,class:"form-control",readonly:""},null,8,At)])]),d.length>0?(c(),m("div",St,[t("button",{type:"submit",class:"btn btn-info w-75 text-center text-white",disabled:i(v)},[M(n(s.translations.continue)+"   ",1),i(v)?_("",!0):(c(),m("i",Nt)),i(v)?(c(),m("span",Ot)):_("",!0)],8,Dt)])):_("",!0)],32)])])])]),y(et,{translations:s.translations,show:i(b),total:x.value,onClose:e[5]||(e[5]=a=>D(b)?b.value=!1:b=!1),onConfirm:j},null,8,["translations","show","total"])])]}),_:1},8,["translations"])}}};export{Ft as default};
