import{s as P,r as g,T,z as j,k as S,B as E,D as v,a as d,h as F,w as L,b as o,t as l,j as R,i as q,u as c,c as p,F as z,f as G,l as k,x,e as w,d as H,I as J}from"./app-BK41XzZo.js";import{A as K}from"./AuthenticatedLayout-BrjZjJ95.js";import{_ as Q}from"./InputError-CqdgP3Gt.js";import{C as I}from"./vue-select-saDOr5HB.js";import{d as W,M as X}from"./debounce-R2oynWee.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Y={class:"section dashboard"},Z={class:"row"},tt={class:"col-lg-12"},ot={class:"card"},at={class:"card-body"},et={class:"card-title"},st={class:"row mb-3"},nt={class:"col-sm-2 col-form-label"},lt={class:"col-sm-10"},it={key:0,class:"row mb-3"},rt={class:"col-sm-2 col-form-label"},dt={class:"col-sm-10"},ct={class:"table"},ut={style:{"min-width":"200px"}},mt=["onUpdate:modelValue","onInput","max"],pt=["onUpdate:modelValue"],yt=["value","onInput"],_t=["onClick"],bt={class:"row"},ht={class:"col-md-6"},ft={class:"col-md-6"},vt={class:"text-center mt-3"},qt=["disabled"],wt={key:0,class:"bi bi-save"},gt={key:1,class:"spinner-border spinner-border-sm"},At={__name:"Edit",props:{products:Array,all_products:Array,customers:Array,order:Object,translations:Object},setup(e){var V;let y=P();const r=e;let _=g(!1),u=g(!1);const m=T({id:r.order.id,customer_id:r.order.customer_id,items:r.order.items||[],total_amount:r.order.total_amount||0}),h=g(r.customers.find(t=>t.id===r.order.customer_id)||null),b=j(((V=r.order.items)==null?void 0:V.map(t=>{var a;return{product_id:t.product_id,quantity:t.quantity,price:t.price,max_quantity:((a=r.products.find(n=>n.id===t.product_id))==null?void 0:a.max_quantity)||9999}}))||[]),$=t=>{h.value=t,m.customer_id=t?t.id:null},A=t=>{const a=r.products.find(n=>n.id===t.product_id);a&&(t.price=a.price,t.max_quantity=a.max_quantity)},U=t=>{const a=r.products.find(n=>n.id===t.product_id);a&&t.quantity>a.max_quantity&&(t.quantity=a.max_quantity)},M=()=>{b.push({product_id:"",quantity:1,price:0})},B=t=>{b.splice(t,1)},f=S(()=>b.reduce((t,a)=>t+a.quantity*a.price,0));E(f,t=>{m.total_amount=t});const D=()=>{u.value=!0},N=async t=>{_.value=!0;const a={total_amount:m.total_amount,total_paid:t.amountDollar??0,customer_id:m.customer_id,date:t.date,notes:t.notes,discount_amount:t.discount_amount??0,discount_rate:t.discount_rate??0,items:b.map(n=>({product_id:n.product_id,quantity:n.quantity,price:n.price}))};try{const n=await v.put(route("orders.update",m.id),a);(n.status===200||n.status===201)&&(window.location.href="/orders")}catch(n){console.error("خطأ أثناء تحديث الفاتورة:",n)}finally{_.value=!1,u.value=!1}};W(async()=>{if(barcode.value)try{const t=await v.get(`/api/products/${barcode.value}`);if(t.data.id){const a=await v.get(`/api/check-stock/${t.data.id}`);if(a.data.available_quantity>0){const n=invoiceItems.find(s=>s.product_id===t.data.id);n?n.quantity+1<=a.data.available_quantity?n.quantity+=1:y.warning("لا توجد كمية كافية في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0}):invoiceItems.push({product_id:t.data.id,quantity:1,price:t.data.price}),barcode.value=""}else y.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}else y.error("تعذر تحقق من المنتج عن طريق الباركود",{timeout:5e3,position:"bottom-right",rtl:!0})}catch{y.warning("المادة غير متوفرة في المخزون",{timeout:5e3,position:"bottom-right",rtl:!0})}},500);const O=async t=>{try{const a=await v.get(`/api/check-stock/${t.product_id}`);t.quantity>a.data.available_quantity&&(y.success(`الكمية المتوفرة فقط: ${a.data.available_quantity}`,{timeout:5e3,position:"bottom-right",rtl:!0}),t.quantity=a.data.available_quantity)}catch(a){console.error("خطأ عند التحقق من المخزون:",a)}};return(t,a)=>(d(),F(K,{translations:e.translations},{default:L(()=>{var n;return[o("section",Y,[o("div",Z,[o("div",tt,[o("div",ot,[o("div",at,[o("h5",et,l(e.translations.edit_invoice),1),o("form",{class:"row g-3",onSubmit:R(D,["prevent"])},[o("div",st,[o("label",nt,l(e.translations.client),1),o("div",lt,[q(c(I),{modelValue:h.value,"onUpdate:modelValue":a[0]||(a[0]=s=>h.value=s),options:e.customers,label:"name","track-by":"id",reduce:s=>({id:s.id,name:s.name}),clearable:!0,placeholder:e.translations.select_customer,onInput:$},null,8,["modelValue","options","reduce","placeholder"]),q(Q,{message:c(m).errors.customer_id},null,8,["message"])])]),h.value?(d(),p("div",it,[o("label",rt,l(e.translations.products),1),o("div",dt,[o("table",ct,[o("thead",null,[o("tr",null,[o("th",null,l(e.translations.product),1),o("th",null,l(e.translations.quantity),1),o("th",null,l(e.translations.price)+" "+l(e.translations.dollar),1),o("th",null,l(e.translations.total)+" "+l(e.translations.dollar),1),o("th",null,l(e.translations.actions),1)])]),o("tbody",null,[(d(!0),p(z,null,G(b,(s,C)=>(d(),p("tr",{key:C},[o("td",ut,[q(c(I),{modelValue:s.product_id,"onUpdate:modelValue":i=>s.product_id=i,options:e.all_products,label:"name","track-by":"id",reduce:i=>i.id,placeholder:e.translations.select_product,class:"form-control",onInput:i=>A(s)},null,8,["modelValue","onUpdate:modelValue","options","reduce","placeholder","onInput"])]),o("td",null,[k(o("input",{type:"number","onUpdate:modelValue":i=>s.quantity=i,onInput:i=>U(s),min:"1",max:s.max_quantity,class:"form-control"},null,40,mt),[[x,s.quantity]])]),o("td",null,[k(o("input",{type:"number","onUpdate:modelValue":i=>s.price=i,min:"0",class:"form-control"},null,8,pt),[[x,s.price]])]),o("td",null,[o("input",{type:"number",value:s.quantity*s.price,class:"form-control",onInput:i=>O(s)},null,40,yt)]),o("td",null,[o("button",{type:"button",class:"btn btn-danger",onClick:i=>B(C)},a[3]||(a[3]=[o("i",{class:"bi bi-trash"},null,-1)]),8,_t)])]))),128))])]),(n=e.products)!=null&&n.length?(d(),p("button",{key:0,type:"button",class:"btn btn-primary",onClick:M},l(e.translations.add_product),1)):w("",!0)])])):w("",!0),o("div",bt,[o("div",ht,[o("strong",null,l(e.translations.total)+" "+l(e.translations.dollar)+":",1)]),o("div",ft,[k(o("input",{type:"number","onUpdate:modelValue":a[1]||(a[1]=s=>f.value=s),class:"form-control",readonly:""},null,512),[[x,f.value]])])]),o("div",vt,[o("button",{type:"submit",class:"btn btn-primary",disabled:c(_)},[H(l(e.translations.save)+"   ",1),c(_)?w("",!0):(d(),p("i",wt)),c(_)?(d(),p("span",gt)):w("",!0)],8,qt)])],32)])])])]),q(X,{translations:e.translations,show:c(u),total:f.value,onClose:a[2]||(a[2]=s=>J(u)?u.value=!1:u=!1),onConfirm:N},null,8,["translations","show","total"])])]}),_:1},8,["translations"]))}};export{At as default};
