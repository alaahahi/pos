import{s as pt,r as b,T as bt,x as yt,k as z,B as J,E as F,J as G,o as vt,K as ft,a as i,c as ht,w as _t,b as s,d as y,t as a,l as V,y as $,u,I as P,L as H,e as l,F as U,g as B,n as M,f as d,i as O}from"./app-Dyo3CGUB.js";import{_ as gt}from"./AuthenticatedLayout-DQQOHWHW.js";import{_ as kt}from"./InputError-BKaRmLoe.js";import{C as Ct}from"./vue-select-DKiE1Ybt.js";import{d as W,M as wt}from"./debounce-DL-yI6cT.js";import{_ as qt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const xt={class:"pos-header"},It={class:"d-flex justify-content-between align-items-center"},Ft={class:"pos-title"},Vt={class:"pos-container"},$t={class:"pos-products-panel"},Et={class:"pos-search-section"},Dt={class:"search-input-group"},At=["placeholder"],Lt={class:"barcode-section"},Pt=["placeholder"],Ut={key:0,class:"pos-categories"},Bt=["onClick"],Mt={class:"pos-products-grid"},Ot=["onClick"],St={class:"product-image"},Tt=["src","alt"],Kt={key:0,class:"product-stock-badge"},Nt={class:"product-info"},Qt={class:"product-name"},jt={class:"product-model"},Rt={class:"product-price"},zt={class:"product-stock"},Jt={key:1,class:"text-center p-4"},Gt={key:2,class:"no-products"},Ht={class:"pos-cart-panel"},Wt={class:"pos-customer-section"},Xt={class:"form-label"},Yt={class:"pos-cart-section"},Zt={class:"cart-header"},ts={key:0,class:"cart-count"},ss={class:"cart-items"},es={class:"cart-item-info"},os={class:"item-name"},ns={class:"item-model"},is={class:"cart-item-controls"},as={class:"quantity-controls"},ls=["onClick","disabled"],rs=["onUpdate:modelValue","onInput"],us=["onClick"],cs={class:"price-controls"},ds=["onUpdate:modelValue"],ms={class:"item-total"},ps=["onClick"],bs={key:0,class:"empty-cart"},ys={key:0,class:"pos-summary-section"},vs={class:"summary-row"},fs={class:"summary-row"},hs={class:"summary-row total-row"},_s={class:"total-amount"},gs={key:1,class:"pos-actions-section"},ks=["disabled"],Cs={key:0,class:"bi bi-credit-card"},ws={key:1,class:"spinner-border spinner-border-sm"},qs={key:0,class:"keyboard-shortcuts"},xs={__name:"Create",props:{products:Array,customers:Array,defaultCustomer:Object,translations:Object,defaultCurrency:String,categories:Array},setup(r){var R;let m=pt(),w=b(!1),_=b(""),v=b(""),g=b(!1),S=b(!1),q=b(null),E=b(!1);const T=b(null),x=b(null),p=r,k=b(p.defaultCustomer),C=bt({customer_id:((R=p.defaultCustomer)==null?void 0:R.id)||null,total_amount:0}),n=yt([]),f=b([...p.products]),D=z(()=>n.reduce((o,t)=>o+t.quantity*t.price,0)),X=z(()=>n.reduce((o,t)=>o+t.quantity,0));J(D,o=>{C.total_amount=o}),J(v,W(()=>{L()},300));const Y=o=>{k.value=o,C.customer_id=o?o.id:null},K=o=>{if(o.quantity<=0){m.warning("المنتج غير متوفر في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0});return}const t=n.find(e=>e.product_id===o.id);t?t.quantity<o.quantity?t.quantity+=1:m.warning("لا توجد كمية كافية في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0}):n.push({product_id:o.id,quantity:1,price:o.price})},Z=o=>{n.splice(o,1)},tt=o=>{const t=n[o],e=p.products.find(c=>c.id===t.product_id);t.quantity<e.quantity?t.quantity+=1:m.warning("لا توجد كمية كافية في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0})},st=o=>{const t=n[o];t.quantity>1&&(t.quantity-=1)},N=()=>{n.splice(0)},A=()=>{N(),k.value=null,C.customer_id=null,v.value="",_.value="",f.value=[...p.products]},L=()=>{if(!v.value.trim()){f.value=[...p.products];return}const o=v.value.toLowerCase();f.value=p.products.filter(t=>t.name.toLowerCase().includes(o)||t.model.toLowerCase().includes(o)||t.barcode&&t.barcode.toLowerCase().includes(o))},et=()=>{f.value.length===1&&(K(f.value[0]),v.value="",f.value=[...p.products])},ot=o=>{q.value=o},nt=()=>{q.value=null,f.value=[...p.products]},it=o=>{const t=p.products.find(e=>e.id===o);return t?t.name:""},at=o=>{const t=p.products.find(e=>e.id===o);return t?t.model:""},lt=o=>{o.target.src="/dashboard-assets/img/product-placeholder.svg"},rt=()=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()},ut=()=>{m.info("تم تعليق الطلب",{timeout:3e3,position:"bottom-right",rtl:!0})},ct=()=>{window.print()},Q=()=>{g.value=!0},dt=async o=>{w.value=!0;const t={total_amount:C.total_amount,total_paid:o.amountDollar??0,customer_id:C.customer_id,date:o.date,notes:o.notes,items:n.map(e=>({product_id:e.product_id,quantity:e.quantity,price:e.price}))};try{const e=await F.post("/api/createOrder",t);if(e.status===200||e.status===201){let{id:c,order_id:h}=e.data;m.success("تم حفظ الفاتورة بنجاح",{timeout:3e3,position:"bottom-right",rtl:!0}),o.printInvoice&&window.open(`/api/getIndexAccountsSelas?print=2&transactions_id=${c}&order_id=${h}`,"_blank"),A()}}catch{m.error("خطأ أثناء حفظ الفاتورة",{timeout:5e3,position:"bottom-right",rtl:!0})}finally{w.value=!1,g.value=!1}},I=W(async()=>{if(_.value)try{const o=await F.get(`/api/products/${_.value}`);if(o.data.id){const t=await F.get(`/api/check-stock/${o.data.id}`);if(t.data.available_quantity>0){const e=n.find(c=>c.product_id===o.data.id);e?e.quantity+1<=t.data.available_quantity?e.quantity+=1:m.warning("لا توجد كمية كافية في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0}):n.push({product_id:o.data.id,quantity:1,price:o.data.price}),_.value="",G(()=>{var c;(c=x.value)==null||c.focus()})}else m.warning("المادة غير متوفرة في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0})}else m.error("تعذر العثور على المنتج",{timeout:3e3,position:"bottom-right",rtl:!0})}catch{m.warning("المادة غير متوفرة في المخزون",{timeout:3e3,position:"bottom-right",rtl:!0})}},500),mt=async o=>{try{const t=await F.get(`/api/check-stock/${o.product_id}`);o.quantity>t.data.available_quantity&&(m.warning(`الكمية المتوفرة فقط: ${t.data.available_quantity}`,{timeout:3e3,position:"bottom-right",rtl:!0}),o.quantity=t.data.available_quantity)}catch(t){console.error("خطأ عند التحقق من المخزون:",t)}},j=o=>{var t,e;o.key==="F1"&&(o.preventDefault(),(t=T.value)==null||t.focus()),o.key==="F2"&&(o.preventDefault(),(e=x.value)==null||e.focus()),o.key==="F9"&&n.length>0&&k.value&&(o.preventDefault(),Q()),o.key==="Escape"&&(o.preventDefault(),A()),o.key==="F12"&&(o.preventDefault(),E.value=!E.value)};return vt(()=>{document.addEventListener("keydown",j),G(()=>{var o;(o=x.value)==null||o.focus()})}),ft(()=>{document.removeEventListener("keydown",j)}),(o,t)=>(i(),ht(gt,{translations:r.translations},{default:_t(()=>[s("div",xt,[s("div",It,[s("h2",Ft,[t[6]||(t[6]=s("i",{class:"bi bi-shop"},null,-1)),y(" "+a(r.translations.invoice),1)]),s("div",{class:"pos-actions"},[s("button",{onClick:A,class:"btn btn-outline-danger"},t[7]||(t[7]=[s("i",{class:"bi bi-trash"},null,-1),y(" مسح الكل ")])),s("button",{onClick:rt,class:"btn btn-outline-primary"},t[8]||(t[8]=[s("i",{class:"bi bi-fullscreen"},null,-1),y(" ملء الشاشة ")]))])])]),s("div",Vt,[s("div",$t,[s("div",Et,[s("div",Dt,[V(s("input",{ref_key:"searchInput",ref:T,"onUpdate:modelValue":t[0]||(t[0]=e=>P(v)?v.value=e:v=e),type:"text",class:"form-control pos-search-input",placeholder:r.translations.search_by_name_or_barcode,onInput:L,onKeyup:H(et,["enter"])},null,40,At),[[$,u(v)]]),s("button",{class:"btn btn-primary search-btn",onClick:L},t[9]||(t[9]=[s("i",{class:"bi bi-search"},null,-1)]))]),s("div",Lt,[V(s("input",{ref_key:"barcodeInput",ref:x,"onUpdate:modelValue":t[1]||(t[1]=e=>P(_)?_.value=e:_=e),type:"text",class:"form-control barcode-input",placeholder:r.translations.barcode,onKeyup:[t[2]||(t[2]=(...e)=>u(I)&&u(I)(...e)),t[3]||(t[3]=H((...e)=>u(I)&&u(I)(...e),["enter"]))]},null,40,Pt),[[$,u(_)]]),t[10]||(t[10]=s("i",{class:"bi bi-upc-scan barcode-icon"},null,-1))])]),r.categories&&r.categories.length?(i(),l("div",Ut,[(i(!0),l(U,null,B(r.categories,e=>(i(),l("button",{key:e.id,onClick:c=>ot(e.id),class:M(["btn","category-btn",{active:u(q)===e.id}])},a(e.name),11,Bt))),128)),s("button",{onClick:nt,class:M(["btn","category-btn",{active:u(q)===null}])}," الكل ",2)])):d("",!0),s("div",Mt,[(i(!0),l(U,null,B(f.value,e=>(i(),l("div",{key:e.id,onClick:c=>K(e),class:M(["product-card",{"out-of-stock":e.quantity<=0}])},[s("div",St,[s("img",{src:e.image_url||"/dashboard-assets/img/product-placeholder.svg",alt:e.name,onError:lt},null,40,Tt),e.quantity<=5?(i(),l("div",Kt,a(e.quantity),1)):d("",!0)]),s("div",Nt,[s("h6",Qt,a(e.name),1),s("p",jt,a(e.model),1),s("div",Rt,a(r.defaultCurrency)+" "+a(e.price),1),s("div",zt," المخزون: "+a(e.quantity),1)])],10,Ot))),128))]),u(S)?(i(),l("div",Jt,t[11]||(t[11]=[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"جاري التحميل...")],-1)]))):d("",!0),!u(S)&&f.value.length===0?(i(),l("div",Gt,t[12]||(t[12]=[s("i",{class:"bi bi-box-seam"},null,-1),s("p",null,"لا توجد منتجات",-1)]))):d("",!0)]),s("div",Ht,[s("div",Wt,[s("label",Xt,a(r.translations.client),1),O(u(Ct),{modelValue:k.value,"onUpdate:modelValue":t[4]||(t[4]=e=>k.value=e),options:r.customers,label:"name","track-by":"id",reduce:e=>e,onInput:Y,placeholder:r.translations.select_customer,class:"customer-select"},null,8,["modelValue","options","reduce","placeholder"]),O(kt,{message:u(C).errors.customer_id},null,8,["message"])]),s("div",Yt,[s("div",Zt,[s("h5",null,[t[13]||(t[13]=s("i",{class:"bi bi-cart3"},null,-1)),t[14]||(t[14]=y(" عربة التسوق ")),n.length?(i(),l("span",ts,a(n.length),1)):d("",!0)]),n.length?(i(),l("button",{key:0,onClick:N,class:"btn btn-sm btn-outline-danger"},t[15]||(t[15]=[s("i",{class:"bi bi-trash"},null,-1)]))):d("",!0)]),s("div",ss,[(i(!0),l(U,null,B(n,(e,c)=>(i(),l("div",{key:c,class:"cart-item"},[s("div",es,[s("h6",os,a(it(e.product_id)),1),s("p",ns,a(at(e.product_id)),1)]),s("div",is,[s("div",as,[s("button",{onClick:h=>st(c),class:"btn btn-sm btn-outline-secondary",disabled:e.quantity<=1},t[16]||(t[16]=[s("i",{class:"bi bi-dash"},null,-1)]),8,ls),V(s("input",{"onUpdate:modelValue":h=>e.quantity=h,type:"number",min:"1",class:"form-control quantity-input",onInput:h=>mt(e)},null,40,rs),[[$,e.quantity,void 0,{number:!0}]]),s("button",{onClick:h=>tt(c),class:"btn btn-sm btn-outline-secondary"},t[17]||(t[17]=[s("i",{class:"bi bi-plus"},null,-1)]),8,us)]),s("div",cs,[V(s("input",{"onUpdate:modelValue":h=>e.price=h,type:"number",min:"0",step:"0.01",class:"form-control price-input"},null,8,ds),[[$,e.price,void 0,{number:!0}]])]),s("div",ms,a(r.defaultCurrency)+" "+a((e.quantity*e.price).toFixed(2)),1),s("button",{onClick:h=>Z(c),class:"btn btn-sm btn-danger remove-btn"},t[18]||(t[18]=[s("i",{class:"bi bi-x"},null,-1)]),8,ps)])]))),128))]),n.length===0?(i(),l("div",bs,t[19]||(t[19]=[s("i",{class:"bi bi-cart-x"},null,-1),s("p",null,"عربة التسوق فارغة",-1),s("small",null,"اضغط على المنتجات لإضافتها",-1)]))):d("",!0)]),n.length>0?(i(),l("div",ys,[s("div",vs,[t[20]||(t[20]=s("span",null,"عدد الأصناف:",-1)),s("span",null,a(n.length),1)]),s("div",fs,[t[21]||(t[21]=s("span",null,"إجمالي الكمية:",-1)),s("span",null,a(X.value),1)]),s("div",hs,[t[22]||(t[22]=s("span",null,"الإجمالي:",-1)),s("span",_s,a(r.defaultCurrency)+" "+a(D.value.toFixed(2)),1)])])):d("",!0),n.length>0&&k.value?(i(),l("div",gs,[s("button",{onClick:Q,class:"btn btn-success btn-lg checkout-btn",disabled:u(w)},[u(w)?d("",!0):(i(),l("i",Cs)),u(w)?(i(),l("span",ws)):d("",!0),y(" "+a(r.translations.continue),1)],8,ks),s("div",{class:"quick-actions"},[s("button",{onClick:ut,class:"btn btn-outline-warning"},t[23]||(t[23]=[s("i",{class:"bi bi-pause-circle"},null,-1),y(" تعليق ")])),s("button",{onClick:ct,class:"btn btn-outline-info"},t[24]||(t[24]=[s("i",{class:"bi bi-printer"},null,-1),y(" طباعة ")]))])])):d("",!0)])]),O(wt,{translations:r.translations,show:u(g),total:D.value,defaultCurrency:r.defaultCurrency,onClose:t[5]||(t[5]=e=>P(g)?g.value=!1:g=!1),onConfirm:dt},null,8,["translations","show","total","defaultCurrency"]),u(E)?(i(),l("div",qs,t[25]||(t[25]=[s("div",{class:"shortcuts-content"},[s("h6",null,"اختصارات لوحة المفاتيح"),s("div",{class:"shortcut-item"},[s("kbd",null,"F1"),y(" - البحث ")]),s("div",{class:"shortcut-item"},[s("kbd",null,"F2"),y(" - الباركود ")]),s("div",{class:"shortcut-item"},[s("kbd",null,"F9"),y(" - الدفع ")]),s("div",{class:"shortcut-item"},[s("kbd",null,"Esc"),y(" - مسح الكل ")])],-1)]))):d("",!0)]),_:1},8,["translations"]))}},As=qt(xs,[["__scopeId","data-v-1d90ded6"]]);export{As as default};
