# دليل اختبار إصلاح حذف دفعة من الصندوق

## الخطوات السريعة للاختبار

### الطريقة الأولى: الاختبار اليدوي (موصى به)

1. **افتح المتصفح وانتقل إلى صفحة الصندوق**
   - الرابط: `http://localhost/pos/boxes` (أو حسب إعدادات السيرفر)

2. **سجل الرصيد الحالي**
   - مثال: USD = 1000, IQD = 150000

3. **أضف دفعة جديدة (إيداع)**
   - اختر "إضافة دفعة"
   - أدخل مبلغ: مثلاً 100 دولار
   - سجل ملاحظة: "اختبار إضافة"
   - احفظ

4. **تحقق من زيادة الرصيد**
   - الرصيد الجديد يجب أن يكون: 1100 USD
   - ✓ إذا زاد الرصيد، الإضافة تعمل بشكل صحيح

5. **احذف الدفعة التي أضفتها**
   - اضغط على زر "حذف" للدفعة الجديدة
   - أكد الحذف

6. **تحقق من الرصيد**
   - الرصيد يجب أن يعود إلى: 1000 USD
   - ✓ إذا عاد الرصيد للقيمة الأصلية، الإصلاح ناجح!

### الطريقة الثانية: اختبار السحب

1. **سجل الرصيد الحالي**
   - مثال: IQD = 150000

2. **أضف عملية سحب**
   - اختر "سحب من الصندوق"
   - أدخل مبلغ: مثلاً 50000 دينار
   - سجل ملاحظة: "اختبار سحب"
   - احفظ

3. **تحقق من نقص الرصيد**
   - الرصيد الجديد: 100000 IQD
   - ✓ إذا نقص الرصيد، السحب يعمل بشكل صحيح

4. **احذف عملية السحب**
   - اضغط على زر "حذف"
   - أكد الحذف

5. **تحقق من الرصيد**
   - الرصيد يجب أن يعود إلى: 150000 IQD
   - ✓ إذا عاد الرصيد للقيمة الأصلية، الإصلاح ناجح!

### الطريقة الثالثة: تشغيل سكريبت الاختبار

إذا كنت تفضل الاختبار التلقائي:

```bash
# في PowerShell أو Command Prompt
cd c:\xampp\htdocs\pos
php test_box_deletion.php
```

أو استخدم ملف الـ batch:
```bash
cd c:\xampp\htdocs\pos
run_test.bat
```

## النتائج المتوقعة

### ✓ الحالة الصحيحة (بعد الإصلاح)

| العملية | الرصيد قبل | المبلغ | الرصيد بعد | حذف | الرصيد النهائي |
|---------|-----------|--------|-----------|-----|----------------|
| إيداع | 1000 | +100 | 1100 | ✓ | 1000 |
| سحب | 1000 | -100 | 900 | ✓ | 1000 |

### ✗ الحالة الخاطئة (قبل الإصلاح)

| العملية | الرصيد قبل | المبلغ | الرصيد بعد | حذف | الرصيد النهائي |
|---------|-----------|--------|-----------|-----|----------------|
| إيداع | 1000 | +100 | 1100 | ✓ | 1000 ❌ (كان يصبح 900) |
| سحب | 1000 | -100 | 900 | ✓ | 1000 ❌ (كان يصبح 800) |

## حالات الاختبار الشاملة

### ✓ الحالات التي تم إصلاحها:

1. **حذف إيداع بالدولار**
   - قبل: يطرح المبلغ مرتين (خطأ)
   - بعد: يعيد الرصيد للقيمة الصحيحة ✓

2. **حذف إيداع بالدينار**
   - قبل: يطرح المبلغ مرتين (خطأ)
   - بعد: يعيد الرصيد للقيمة الصحيحة ✓

3. **حذف سحب بالدولار**
   - قبل: يطرح المبلغ بدلاً من إضافته (خطأ)
   - بعد: يعيد الرصيد للقيمة الصحيحة ✓

4. **حذف سحب بالدينار**
   - قبل: يطرح المبلغ بدلاً من إضافته (خطأ)
   - بعد: يعيد الرصيد للقيمة الصحيحة ✓

5. **حذف معاملة مع معاملات فرعية**
   - قبل: لا يحذف المعاملات الفرعية أو لا يعكس تأثيرها (خطأ)
   - بعد: يحذف جميع المعاملات ويعكس تأثيرها بشكل صحيح ✓

## استكشاف الأخطاء

### إذا لم يعمل الاختبار:

1. **تحقق من اتصال قاعدة البيانات**
   ```bash
   php artisan migrate:status
   ```

2. **تحقق من وجود الصندوق الرئيسي**
   - يجب أن يكون هناك مستخدم بالبريد: `mainBox@account.com`
   - يجب أن يكون له محفظة (wallet)

3. **تحقق من السجلات (Logs)**
   ```bash
   # افتح ملف السجلات
   storage/logs/laravel.log
   ```

4. **شغل الأوامر التالية لتهيئة النظام**
   ```bash
   php artisan config:clear
   php artisan cache:clear
   php artisan view:clear
   ```

## الخلاصة

الإصلاح يضمن أن:
- ✓ حذف أي معاملة (إيداع/سحب) يعيد الرصيد للقيمة الصحيحة
- ✓ يعمل مع جميع العملات (USD, IQD, $)
- ✓ يتعامل مع المعاملات الفرعية بشكل صحيح
- ✓ يستخدم Database Transaction لضمان سلامة البيانات
- ✓ يعرض رسائل خطأ واضحة في حالة حدوث مشكلة

---

**للمزيد من المعلومات، راجع**: `BOX_DELETION_FIX_README.md`

